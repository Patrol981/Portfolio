var Fe=Object.defineProperty;var Ne=(Wt,St,v)=>St in Wt?Fe(Wt,St,{enumerable:!0,configurable:!0,writable:!0,value:v}):Wt[St]=v;var Be=(Wt,St,v)=>(Ne(Wt,typeof St!="symbol"?St+"":St,v),v);import{S as Ie,i as We,s as Le,k as Ae,a as qe,l as Ce,m as Se,h as be,c as Oe,n as Me,b as ke,E as Re,I as ze,o as He,w as Ge}from"../chunks/index.41362b95.js";import{G as De,V as Ue,M as Xe,S as _e,C as Ye}from"../chunks/scene.f89cd113.js";function Ee(Wt){throw new Error('Could not dynamically require "'+Wt+'". Please configure the dynamicRequireTargets or/and ignoreDynamicRequires option of @rollup/plugin-commonjs appropriately for this require call to work.')}var Pe={},Qe={get exports(){return Pe},set exports(Wt){Pe=Wt}};(function(Wt,St){(function(v){Wt.exports=v()})(function(){return function v(V,et,p){function e(l,i){if(!et[l]){if(!V[l]){var t=typeof Ee=="function"&&Ee;if(!i&&t)return t(l,!0);if(s)return s(l,!0);throw new Error("Cannot find module '"+l+"'")}var o=et[l]={exports:{}};V[l][0].call(o.exports,function(n){var a=V[l][1][n];return e(a||n)},o,o.exports,v,V,et,p)}return et[l].exports}for(var s=typeof Ee=="function"&&Ee,r=0;r<p.length;r++)e(p[r]);return e}({1:[function(v,V,et){V.exports={name:"cannon",version:"0.6.2",description:"A lightweight 3D physics engine written in JavaScript.",homepage:"https://github.com/schteppe/cannon.js",author:"Stefan Hedman <schteppe@gmail.com> (http://steffe.se)",keywords:["cannon.js","cannon","physics","engine","3d"],main:"./build/cannon.js",engines:{node:"*"},repository:{type:"git",url:"https://github.com/schteppe/cannon.js.git"},bugs:{url:"https://github.com/schteppe/cannon.js/issues"},licenses:[{type:"MIT"}],devDependencies:{jshint:"latest","uglify-js":"latest",nodeunit:"^0.9.0",grunt:"~0.4.0","grunt-contrib-jshint":"~0.1.1","grunt-contrib-nodeunit":"^0.4.1","grunt-contrib-concat":"~0.1.3","grunt-contrib-uglify":"^0.5.1","grunt-browserify":"^2.1.4","grunt-contrib-yuidoc":"^0.5.2",browserify:"*"},dependencies:{}}},{}],2:[function(v,V,et){V.exports={version:v("../package.json").version,AABB:v("./collision/AABB"),ArrayCollisionMatrix:v("./collision/ArrayCollisionMatrix"),Body:v("./objects/Body"),Box:v("./shapes/Box"),Broadphase:v("./collision/Broadphase"),Constraint:v("./constraints/Constraint"),ContactEquation:v("./equations/ContactEquation"),Narrowphase:v("./world/Narrowphase"),ConeTwistConstraint:v("./constraints/ConeTwistConstraint"),ContactMaterial:v("./material/ContactMaterial"),ConvexPolyhedron:v("./shapes/ConvexPolyhedron"),Cylinder:v("./shapes/Cylinder"),DistanceConstraint:v("./constraints/DistanceConstraint"),Equation:v("./equations/Equation"),EventTarget:v("./utils/EventTarget"),FrictionEquation:v("./equations/FrictionEquation"),GSSolver:v("./solver/GSSolver"),GridBroadphase:v("./collision/GridBroadphase"),Heightfield:v("./shapes/Heightfield"),HingeConstraint:v("./constraints/HingeConstraint"),LockConstraint:v("./constraints/LockConstraint"),Mat3:v("./math/Mat3"),Material:v("./material/Material"),NaiveBroadphase:v("./collision/NaiveBroadphase"),ObjectCollisionMatrix:v("./collision/ObjectCollisionMatrix"),Pool:v("./utils/Pool"),Particle:v("./shapes/Particle"),Plane:v("./shapes/Plane"),PointToPointConstraint:v("./constraints/PointToPointConstraint"),Quaternion:v("./math/Quaternion"),Ray:v("./collision/Ray"),RaycastVehicle:v("./objects/RaycastVehicle"),RaycastResult:v("./collision/RaycastResult"),RigidVehicle:v("./objects/RigidVehicle"),RotationalEquation:v("./equations/RotationalEquation"),RotationalMotorEquation:v("./equations/RotationalMotorEquation"),SAPBroadphase:v("./collision/SAPBroadphase"),SPHSystem:v("./objects/SPHSystem"),Shape:v("./shapes/Shape"),Solver:v("./solver/Solver"),Sphere:v("./shapes/Sphere"),SplitSolver:v("./solver/SplitSolver"),Spring:v("./objects/Spring"),Trimesh:v("./shapes/Trimesh"),Vec3:v("./math/Vec3"),Vec3Pool:v("./utils/Vec3Pool"),World:v("./world/World")}},{"../package.json":1,"./collision/AABB":3,"./collision/ArrayCollisionMatrix":4,"./collision/Broadphase":5,"./collision/GridBroadphase":6,"./collision/NaiveBroadphase":7,"./collision/ObjectCollisionMatrix":8,"./collision/Ray":9,"./collision/RaycastResult":10,"./collision/SAPBroadphase":11,"./constraints/ConeTwistConstraint":12,"./constraints/Constraint":13,"./constraints/DistanceConstraint":14,"./constraints/HingeConstraint":15,"./constraints/LockConstraint":16,"./constraints/PointToPointConstraint":17,"./equations/ContactEquation":19,"./equations/Equation":20,"./equations/FrictionEquation":21,"./equations/RotationalEquation":22,"./equations/RotationalMotorEquation":23,"./material/ContactMaterial":24,"./material/Material":25,"./math/Mat3":27,"./math/Quaternion":28,"./math/Vec3":30,"./objects/Body":31,"./objects/RaycastVehicle":32,"./objects/RigidVehicle":33,"./objects/SPHSystem":34,"./objects/Spring":35,"./shapes/Box":37,"./shapes/ConvexPolyhedron":38,"./shapes/Cylinder":39,"./shapes/Heightfield":40,"./shapes/Particle":41,"./shapes/Plane":42,"./shapes/Shape":43,"./shapes/Sphere":44,"./shapes/Trimesh":45,"./solver/GSSolver":46,"./solver/Solver":47,"./solver/SplitSolver":48,"./utils/EventTarget":49,"./utils/Pool":51,"./utils/Vec3Pool":54,"./world/Narrowphase":55,"./world/World":56}],3:[function(v,V,et){var p=v("../math/Vec3");v("../utils/Utils"),V.exports=e;function e(l){l=l||{},this.lowerBound=new p,l.lowerBound&&this.lowerBound.copy(l.lowerBound),this.upperBound=new p,l.upperBound&&this.upperBound.copy(l.upperBound)}var s=new p;e.prototype.setFromPoints=function(l,i,t,o){var n=this.lowerBound,a=this.upperBound,c=t;n.copy(l[0]),c&&c.vmult(n,n),a.copy(n);for(var h=1;h<l.length;h++){var u=l[h];c&&(c.vmult(u,s),u=s),u.x>a.x&&(a.x=u.x),u.x<n.x&&(n.x=u.x),u.y>a.y&&(a.y=u.y),u.y<n.y&&(n.y=u.y),u.z>a.z&&(a.z=u.z),u.z<n.z&&(n.z=u.z)}return i&&(i.vadd(n,n),i.vadd(a,a)),o&&(n.x-=o,n.y-=o,n.z-=o,a.x+=o,a.y+=o,a.z+=o),this},e.prototype.copy=function(l){return this.lowerBound.copy(l.lowerBound),this.upperBound.copy(l.upperBound),this},e.prototype.clone=function(){return new e().copy(this)},e.prototype.extend=function(l){var i=l.lowerBound.x;this.lowerBound.x>i&&(this.lowerBound.x=i);var t=l.upperBound.x;this.upperBound.x<t&&(this.upperBound.x=t);var i=l.lowerBound.y;this.lowerBound.y>i&&(this.lowerBound.y=i);var t=l.upperBound.y;this.upperBound.y<t&&(this.upperBound.y=t);var i=l.lowerBound.z;this.lowerBound.z>i&&(this.lowerBound.z=i);var t=l.upperBound.z;this.upperBound.z<t&&(this.upperBound.z=t)},e.prototype.overlaps=function(l){var i=this.lowerBound,t=this.upperBound,o=l.lowerBound,n=l.upperBound;return(o.x<=t.x&&t.x<=n.x||i.x<=n.x&&n.x<=t.x)&&(o.y<=t.y&&t.y<=n.y||i.y<=n.y&&n.y<=t.y)&&(o.z<=t.z&&t.z<=n.z||i.z<=n.z&&n.z<=t.z)},e.prototype.contains=function(l){var i=this.lowerBound,t=this.upperBound,o=l.lowerBound,n=l.upperBound;return i.x<=o.x&&t.x>=n.x&&i.y<=o.y&&t.y>=n.y&&i.z<=o.z&&t.z>=n.z},e.prototype.getCorners=function(l,i,t,o,n,a,c,h){var u=this.lowerBound,d=this.upperBound;l.copy(u),i.set(d.x,u.y,u.z),t.set(d.x,d.y,u.z),o.set(u.x,d.y,d.z),n.set(d.x,u.y,u.z),a.set(u.x,d.y,u.z),c.set(u.x,u.y,d.z),h.copy(d)};var r=[new p,new p,new p,new p,new p,new p,new p,new p];e.prototype.toLocalFrame=function(l,i){var t=r,o=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(o,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToLocal(b,b)}return i.setFromPoints(t)},e.prototype.toWorldFrame=function(l,i){var t=r,o=t[0],n=t[1],a=t[2],c=t[3],h=t[4],u=t[5],d=t[6],x=t[7];this.getCorners(o,n,a,c,h,u,d,x);for(var f=0;f!==8;f++){var b=t[f];l.pointToWorld(b,b)}return i.setFromPoints(t)}},{"../math/Vec3":30,"../utils/Utils":53}],4:[function(v,V,et){V.exports=p;function p(){this.matrix=[]}p.prototype.get=function(e,s){if(e=e.index,s=s.index,s>e){var r=s;s=e,e=r}return this.matrix[(e*(e+1)>>1)+s-1]},p.prototype.set=function(e,s,r){if(e=e.index,s=s.index,s>e){var l=s;s=e,e=l}this.matrix[(e*(e+1)>>1)+s-1]=r?1:0},p.prototype.reset=function(){for(var e=0,s=this.matrix.length;e!==s;e++)this.matrix[e]=0},p.prototype.setNumObjects=function(e){this.matrix.length=e*(e-1)>>1}},{}],5:[function(v,V,et){var p=v("../objects/Body"),e=v("../math/Vec3"),s=v("../math/Quaternion");v("../shapes/Shape"),v("../shapes/Plane"),V.exports=r;function r(){this.world=null,this.useBoundingBoxes=!1,this.dirty=!0}r.prototype.collisionPairs=function(c,h,u){throw new Error("collisionPairs not implemented for this BroadPhase class!")};var l=p.STATIC|p.KINEMATIC;r.prototype.needBroadphaseCollision=function(c,h){return!(!(c.collisionFilterGroup&h.collisionFilterMask)||!(h.collisionFilterGroup&c.collisionFilterMask)||(c.type&l||c.sleepState===p.SLEEPING)&&(h.type&l||h.sleepState===p.SLEEPING))},r.prototype.intersectionTest=function(c,h,u,d){this.useBoundingBoxes?this.doBoundingBoxBroadphase(c,h,u,d):this.doBoundingSphereBroadphase(c,h,u,d)};var i=new e;new e,new s,new e,r.prototype.doBoundingSphereBroadphase=function(c,h,u,d){var x=i;h.position.vsub(c.position,x);var f=Math.pow(c.boundingRadius+h.boundingRadius,2),b=x.norm2();b<f&&(u.push(c),d.push(h))},r.prototype.doBoundingBoxBroadphase=function(c,h,u,d){c.aabbNeedsUpdate&&c.computeAABB(),h.aabbNeedsUpdate&&h.computeAABB(),c.aabb.overlaps(h.aabb)&&(u.push(c),d.push(h))};var t={keys:[]},o=[],n=[];r.prototype.makePairsUnique=function(c,h){for(var u=t,d=o,x=n,f=c.length,b=0;b!==f;b++)d[b]=c[b],x[b]=h[b];c.length=0,h.length=0;for(var b=0;b!==f;b++){var G=d[b].id,st=x[b].id,T=G<st?G+","+st:st+","+G;u[T]=b,u.keys.push(T)}for(var b=0;b!==u.keys.length;b++){var T=u.keys.pop(),k=u[T];c.push(d[k]),h.push(x[k]),delete u[T]}},r.prototype.setWorld=function(c){};var a=new e;r.boundingSphereCheck=function(c,h){var u=a;return c.position.vsub(h.position,u),Math.pow(c.shape.boundingSphereRadius+h.shape.boundingSphereRadius,2)>u.norm2()},r.prototype.aabbQuery=function(c,h,u){return console.warn(".aabbQuery is not implemented in this Broadphase subclass."),[]}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Plane":42,"../shapes/Shape":43}],6:[function(v,V,et){V.exports=r;var p=v("./Broadphase"),e=v("../math/Vec3"),s=v("../shapes/Shape");function r(i,t,o,n,a){p.apply(this),this.nx=o||10,this.ny=n||10,this.nz=a||10,this.aabbMin=i||new e(100,100,100),this.aabbMax=t||new e(-100,-100,-100);var c=this.nx*this.ny*this.nz;if(c<=0)throw"GridBroadphase: Each dimension's n must be >0";this.bins=[],this.binLengths=[],this.bins.length=c,this.binLengths.length=c;for(var h=0;h<c;h++)this.bins[h]=[],this.binLengths[h]=0}r.prototype=new p,r.prototype.constructor=r;var l=new e;new e,r.prototype.collisionPairs=function(i,t,o){var n=i.numObjects(),a=i.bodies,H=this.aabbMax,C=this.aabbMin,c=this.nx,h=this.ny,u=this.nz,d=h*u,x=u,f=1,b=H.x,G=H.y,st=H.z,T=C.x,k=C.y,M=C.z,B=c/(b-T),N=h/(G-k),F=u/(st-M),j=(b-T)/c,K=(G-k)/h,pt=(st-M)/u,z=Math.sqrt(j*j+K*K+pt*pt)*.5,E=s.types,Y=E.SPHERE,q=E.PLANE;E.BOX,E.COMPOUND,E.CONVEXPOLYHEDRON;for(var g=this.bins,R=this.binLengths,w=this.bins.length,m=0;m!==w;m++)R[m]=0;var y=Math.ceil,C=Math.min,H=Math.max;function W(ne,ue,ae,Kt,jt,ve,pe){var oe=(ne-T)*B|0,ee=(ue-k)*N|0,Qt=(ae-M)*F|0,re=y((Kt-T)*B),ie=y((jt-k)*N),Dt=y((ve-M)*F);oe<0?oe=0:oe>=c&&(oe=c-1),ee<0?ee=0:ee>=h&&(ee=h-1),Qt<0?Qt=0:Qt>=u&&(Qt=u-1),re<0?re=0:re>=c&&(re=c-1),ie<0?ie=0:ie>=h&&(ie=h-1),Dt<0?Dt=0:Dt>=u&&(Dt=u-1),oe*=d,ee*=x,Qt*=f,re*=d,ie*=x,Dt*=f;for(var de=oe;de<=re;de+=d)for(var fe=ee;fe<=ie;fe+=x)for(var ye=Qt;ye<=Dt;ye+=f){var xe=de+fe+ye;g[xe][R[xe]++]=pe}}for(var m=0;m!==n;m++){var A=a[m],L=A.shape;switch(L.type){case Y:var X=A.position.x,ut=A.position.y,lt=A.position.z,at=L.radius;W(X-at,ut-at,lt-at,X+at,ut+at,lt+at,A);break;case q:L.worldNormalNeedsUpdate&&L.computeWorldNormal(A.quaternion);var O=L.worldNormal,Q=T+j*.5-A.position.x,bt=k+K*.5-A.position.y,ft=M+pt*.5-A.position.z,Pt=l;Pt.set(Q,bt,ft);for(var ct=0,Mt=0;ct!==c;ct++,Mt+=d,Pt.y=bt,Pt.x+=j)for(var zt=0,Rt=0;zt!==h;zt++,Rt+=x,Pt.z=ft,Pt.y+=K)for(var Tt=0,Et=0;Tt!==u;Tt++,Et+=f,Pt.z+=pt)if(Pt.dot(O)<z){var Ft=Mt+Rt+Et;g[Ft][R[Ft]++]=A}break;default:A.aabbNeedsUpdate&&A.computeAABB(),W(A.aabb.lowerBound.x,A.aabb.lowerBound.y,A.aabb.lowerBound.z,A.aabb.upperBound.x,A.aabb.upperBound.y,A.aabb.upperBound.z,A);break}}for(var m=0;m!==w;m++){var At=R[m];if(At>1)for(var qt=g[m],ct=0;ct!==At;ct++)for(var A=qt[ct],zt=0;zt!==ct;zt++){var Ut=qt[zt];this.needBroadphaseCollision(A,Ut)&&this.intersectionTest(A,Ut,t,o)}}this.makePairsUnique(t,o)}},{"../math/Vec3":30,"../shapes/Shape":43,"./Broadphase":5}],7:[function(v,V,et){V.exports=s;var p=v("./Broadphase"),e=v("./AABB");function s(){p.apply(this)}s.prototype=new p,s.prototype.constructor=s,s.prototype.collisionPairs=function(r,l,i){var t=r.bodies,o=t.length,n,a,c,h;for(n=0;n!==o;n++)for(a=0;a!==n;a++)c=t[n],h=t[a],this.needBroadphaseCollision(c,h)&&this.intersectionTest(c,h,l,i)},new e,s.prototype.aabbQuery=function(r,l,i){i=i||[];for(var t=0;t<r.bodies.length;t++){var o=r.bodies[t];o.aabbNeedsUpdate&&o.computeAABB(),o.aabb.overlaps(l)&&i.push(o)}return i}},{"./AABB":3,"./Broadphase":5}],8:[function(v,V,et){V.exports=p;function p(){this.matrix={}}p.prototype.get=function(e,s){if(e=e.id,s=s.id,s>e){var r=s;s=e,e=r}return e+"-"+s in this.matrix},p.prototype.set=function(e,s,r){if(e=e.id,s=s.id,s>e){var l=s;s=e,e=l}r?this.matrix[e+"-"+s]=!0:delete this.matrix[e+"-"+s]},p.prototype.reset=function(){this.matrix={}},p.prototype.setNumObjects=function(e){}},{}],9:[function(v,V,et){V.exports=t;var p=v("../math/Vec3"),e=v("../math/Quaternion"),s=v("../math/Transform");v("../shapes/ConvexPolyhedron"),v("../shapes/Box");var r=v("../collision/RaycastResult"),l=v("../shapes/Shape"),i=v("../collision/AABB");function t(w,m){this.from=w?w.clone():new p,this.to=m?m.clone():new p,this._direction=new p,this.precision=1e-4,this.checkCollisionResponse=!0,this.skipBackfaces=!1,this.collisionFilterMask=-1,this.collisionFilterGroup=-1,this.mode=t.ANY,this.result=new r,this.hasHit=!1,this.callback=function(y){}}t.prototype.constructor=t,t.CLOSEST=1,t.ANY=2,t.ALL=4;var o=new i,n=[];t.prototype.intersectWorld=function(w,m){return this.mode=m.mode||t.ANY,this.result=m.result||new r,this.skipBackfaces=!!m.skipBackfaces,this.collisionFilterMask=typeof m.collisionFilterMask<"u"?m.collisionFilterMask:-1,this.collisionFilterGroup=typeof m.collisionFilterGroup<"u"?m.collisionFilterGroup:-1,m.from&&this.from.copy(m.from),m.to&&this.to.copy(m.to),this.callback=m.callback||function(){},this.hasHit=!1,this.result.reset(),this._updateDirection(),this.getAABB(o),n.length=0,w.broadphase.aabbQuery(w,o,n),this.intersectBodies(n),this.hasHit};var a=new p,c=new p;t.pointInTriangle=h;function h(w,m,y,C){C.vsub(m,q),y.vsub(m,a),w.vsub(m,c);var H=q.dot(q),W=q.dot(a),A=q.dot(c),L=a.dot(a),X=a.dot(c),ut,lt;return(ut=L*A-W*X)>=0&&(lt=H*X-W*A)>=0&&ut+lt<H*L-W*W}var u=new p,d=new e;t.prototype.intersectBody=function(w,m){m&&(this.result=m,this._updateDirection());var y=this.checkCollisionResponse;if(!(y&&!w.collisionResponse)&&!(!(this.collisionFilterGroup&w.collisionFilterMask)||!(w.collisionFilterGroup&this.collisionFilterMask)))for(var C=u,H=d,W=0,A=w.shapes.length;W<A;W++){var L=w.shapes[W];if(!(y&&!L.collisionResponse)&&(w.quaternion.mult(w.shapeOrientations[W],H),w.quaternion.vmult(w.shapeOffsets[W],C),C.vadd(w.position,C),this.intersectShape(L,H,C,w),this.result._shouldStop))break}},t.prototype.intersectBodies=function(w,m){m&&(this.result=m,this._updateDirection());for(var y=0,C=w.length;!this.result._shouldStop&&y<C;y++)this.intersectBody(w[y])},t.prototype._updateDirection=function(){this.to.vsub(this.from,this._direction),this._direction.normalize()},t.prototype.intersectShape=function(w,m,y,C){var H=this.from,W=R(H,this._direction,y);if(!(W>w.boundingSphereRadius)){var A=this[w.type];A&&A.call(this,w,m,y,C)}},new p,new p;var x=new p,f=new p,b=new p,G=new p;new p,new r,t.prototype.intersectBox=function(w,m,y,C){return this.intersectConvex(w.convexPolyhedronRepresentation,m,y,C)},t.prototype[l.types.BOX]=t.prototype.intersectBox,t.prototype.intersectPlane=function(w,m,y,C){var H=this.from,W=this.to,A=this._direction,L=new p(0,0,1);m.vmult(L,L);var X=new p;H.vsub(y,X);var ut=X.dot(L);W.vsub(y,X);var lt=X.dot(L);if(!(ut*lt>0)&&!(H.distanceTo(W)<ut)){var at=L.dot(A);if(!(Math.abs(at)<this.precision)){var O=new p,Q=new p,bt=new p;H.vsub(y,O);var ft=-L.dot(O)/at;A.scale(ft,Q),H.vadd(Q,bt),this.reportIntersection(L,bt,w,C,-1)}}},t.prototype[l.types.PLANE]=t.prototype.intersectPlane,t.prototype.getAABB=function(w){var m=this.to,y=this.from;w.lowerBound.x=Math.min(m.x,y.x),w.lowerBound.y=Math.min(m.y,y.y),w.lowerBound.z=Math.min(m.z,y.z),w.upperBound.x=Math.max(m.x,y.x),w.upperBound.y=Math.max(m.y,y.y),w.upperBound.z=Math.max(m.z,y.z)};var st={faceList:[0]};t.prototype.intersectHeightfield=function(w,m,y,C){w.data,w.elementSize;var H=new p,W=new t(this.from,this.to);s.pointToLocalFrame(y,m,W.from,W.from),s.pointToLocalFrame(y,m,W.to,W.to);var A=[],L=null,X=null,ut=null,lt=null,at=w.getIndexOfPosition(W.from.x,W.from.y,A,!1);if(at&&(L=A[0],X=A[1],ut=A[0],lt=A[1]),at=w.getIndexOfPosition(W.to.x,W.to.y,A,!1),at&&((L===null||A[0]<L)&&(L=A[0]),(ut===null||A[0]>ut)&&(ut=A[0]),(X===null||A[1]<X)&&(X=A[1]),(lt===null||A[1]>lt)&&(lt=A[1])),L!==null){var O=[];w.getRectMinMax(L,X,ut,lt,O);for(var Q=L;Q<=ut;Q++)for(var bt=X;bt<=lt;bt++){if(this.result._shouldStop||(w.getConvexTrianglePillar(Q,bt,!1),s.pointToWorldFrame(y,m,w.pillarOffset,H),this.intersectConvex(w.pillarConvex,m,H,C,st),this.result._shouldStop))return;w.getConvexTrianglePillar(Q,bt,!0),s.pointToWorldFrame(y,m,w.pillarOffset,H),this.intersectConvex(w.pillarConvex,m,H,C,st)}}},t.prototype[l.types.HEIGHTFIELD]=t.prototype.intersectHeightfield;var T=new p,k=new p;t.prototype.intersectSphere=function(w,m,y,C){var H=this.from,W=this.to,A=w.radius,L=Math.pow(W.x-H.x,2)+Math.pow(W.y-H.y,2)+Math.pow(W.z-H.z,2),X=2*((W.x-H.x)*(H.x-y.x)+(W.y-H.y)*(H.y-y.y)+(W.z-H.z)*(H.z-y.z)),ut=Math.pow(H.x-y.x,2)+Math.pow(H.y-y.y,2)+Math.pow(H.z-y.z,2)-Math.pow(A,2),lt=Math.pow(X,2)-4*L*ut,at=T,O=k;if(!(lt<0))if(lt===0)H.lerp(W,lt,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1);else{var Q=(-X-Math.sqrt(lt))/(2*L),bt=(-X+Math.sqrt(lt))/(2*L);if(Q>=0&&Q<=1&&(H.lerp(W,Q,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1)),this.result._shouldStop)return;bt>=0&&bt<=1&&(H.lerp(W,bt,at),at.vsub(y,O),O.normalize(),this.reportIntersection(O,at,w,C,-1))}},t.prototype[l.types.SPHERE]=t.prototype.intersectSphere;var M=new p;new p,new p;var B=new p;t.prototype.intersectConvex=function(m,y,C,H,W){for(var A=M,L=B,X=W&&W.faceList||null,ut=m.faces,lt=m.vertices,at=m.faceNormals,O=this._direction,Q=this.from,bt=this.to,ft=Q.distanceTo(bt),Pt=X?X.length:ut.length,ct=this.result,Mt=0;!ct._shouldStop&&Mt<Pt;Mt++){var zt=X?X[Mt]:Mt,Rt=ut[zt],Tt=at[zt],Et=y,Ft=C;L.copy(lt[Rt[0]]),Et.vmult(L,L),L.vadd(Ft,L),L.vsub(Q,L),Et.vmult(Tt,A);var At=O.dot(A);if(!(Math.abs(At)<this.precision)){var qt=A.dot(L)/At;if(!(qt<0)){O.mult(qt,x),x.vadd(Q,x),f.copy(lt[Rt[0]]),Et.vmult(f,f),Ft.vadd(f,f);for(var Ut=1;!ct._shouldStop&&Ut<Rt.length-1;Ut++){b.copy(lt[Rt[Ut]]),G.copy(lt[Rt[Ut+1]]),Et.vmult(b,b),Et.vmult(G,G),Ft.vadd(b,b),Ft.vadd(G,G);var ne=x.distanceTo(Q);!(h(x,f,b,G)||h(x,b,f,G))||ne>ft||this.reportIntersection(A,x,m,H,zt)}}}}},t.prototype[l.types.CONVEXPOLYHEDRON]=t.prototype.intersectConvex;var N=new p,F=new p,j=new p,K=new p,pt=new p,z=new p;new i;var E=[],Y=new s;t.prototype.intersectTrimesh=function(m,y,C,H,W){var A=N,L=E,X=Y,ut=B,lt=F,at=j,O=K,Q=z,bt=pt;W&&W.faceList;var ft=m.indices;m.vertices,m.faceNormals;var Pt=this.from,ct=this.to,Mt=this._direction;X.position.copy(C),X.quaternion.copy(y),s.vectorToLocalFrame(C,y,Mt,lt),s.pointToLocalFrame(C,y,Pt,at),s.pointToLocalFrame(C,y,ct,O);var zt=at.distanceSquared(O);m.tree.rayQuery(this,X,L);for(var Rt=0,Tt=L.length;!this.result._shouldStop&&Rt!==Tt;Rt++){var Et=L[Rt];m.getNormal(Et,A),m.getVertex(ft[Et*3],f),f.vsub(at,ut);var Ft=lt.dot(A),At=A.dot(ut)/Ft;if(!(At<0)){lt.scale(At,x),x.vadd(at,x),m.getVertex(ft[Et*3+1],b),m.getVertex(ft[Et*3+2],G);var qt=x.distanceSquared(at);!(h(x,b,f,G)||h(x,f,b,G))||qt>zt||(s.vectorToWorldFrame(y,A,bt),s.pointToWorldFrame(C,y,x,Q),this.reportIntersection(bt,Q,m,H,Et))}}L.length=0},t.prototype[l.types.TRIMESH]=t.prototype.intersectTrimesh,t.prototype.reportIntersection=function(w,m,y,C,H){var W=this.from,A=this.to,L=W.distanceTo(m),X=this.result;if(!(this.skipBackfaces&&w.dot(this._direction)>0))switch(X.hitFaceIndex=typeof H<"u"?H:-1,this.mode){case t.ALL:this.hasHit=!0,X.set(W,A,w,m,y,C,L),X.hasHit=!0,this.callback(X);break;case t.CLOSEST:(L<X.distance||!X.hasHit)&&(this.hasHit=!0,X.hasHit=!0,X.set(W,A,w,m,y,C,L));break;case t.ANY:this.hasHit=!0,X.hasHit=!0,X.set(W,A,w,m,y,C,L),X._shouldStop=!0;break}};var q=new p,g=new p;function R(w,m,y){y.vsub(w,q);var C=q.dot(m);m.mult(C,g),g.vadd(w,g);var H=y.distanceTo(g);return H}},{"../collision/AABB":3,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/Box":37,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43}],10:[function(v,V,et){var p=v("../math/Vec3");V.exports=e;function e(){this.rayFromWorld=new p,this.rayToWorld=new p,this.hitNormalWorld=new p,this.hitPointWorld=new p,this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1}e.prototype.reset=function(){this.rayFromWorld.setZero(),this.rayToWorld.setZero(),this.hitNormalWorld.setZero(),this.hitPointWorld.setZero(),this.hasHit=!1,this.shape=null,this.body=null,this.hitFaceIndex=-1,this.distance=-1,this._shouldStop=!1},e.prototype.abort=function(){this._shouldStop=!0},e.prototype.set=function(s,r,l,i,t,o,n){this.rayFromWorld.copy(s),this.rayToWorld.copy(r),this.hitNormalWorld.copy(l),this.hitPointWorld.copy(i),this.shape=t,this.body=o,this.distance=n}},{"../math/Vec3":30}],11:[function(v,V,et){v("../shapes/Shape");var p=v("../collision/Broadphase");V.exports=e;function e(s){p.apply(this),this.axisList=[],this.world=null,this.axisIndex=0;var r=this.axisList;this._addBodyHandler=function(l){r.push(l.body)},this._removeBodyHandler=function(l){var i=r.indexOf(l.body);i!==-1&&r.splice(i,1)},s&&this.setWorld(s)}e.prototype=new p,e.prototype.setWorld=function(s){this.axisList.length=0;for(var r=0;r<s.bodies.length;r++)this.axisList.push(s.bodies[r]);s.removeEventListener("addBody",this._addBodyHandler),s.removeEventListener("removeBody",this._removeBodyHandler),s.addEventListener("addBody",this._addBodyHandler),s.addEventListener("removeBody",this._removeBodyHandler),this.world=s,this.dirty=!0},e.insertionSortX=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.x<=i.aabb.lowerBound.x);t--)s[t+1]=s[t];s[t+1]=i}return s},e.insertionSortY=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.y<=i.aabb.lowerBound.y);t--)s[t+1]=s[t];s[t+1]=i}return s},e.insertionSortZ=function(s){for(var r=1,l=s.length;r<l;r++){for(var i=s[r],t=r-1;t>=0&&!(s[t].aabb.lowerBound.z<=i.aabb.lowerBound.z);t--)s[t+1]=s[t];s[t+1]=i}return s},e.prototype.collisionPairs=function(s,r,l){var i=this.axisList,t=i.length,o=this.axisIndex,n,a;for(this.dirty&&(this.sortList(),this.dirty=!1),n=0;n!==t;n++){var c=i[n];for(a=n+1;a<t;a++){var h=i[a];if(this.needBroadphaseCollision(c,h)){if(!e.checkBounds(c,h,o))break;this.intersectionTest(c,h,r,l)}}}},e.prototype.sortList=function(){for(var s=this.axisList,r=this.axisIndex,l=s.length,i=0;i!==l;i++){var t=s[i];t.aabbNeedsUpdate&&t.computeAABB()}r===0?e.insertionSortX(s):r===1?e.insertionSortY(s):r===2&&e.insertionSortZ(s)},e.checkBounds=function(s,r,l){var i,t;l===0?(i=s.position.x,t=r.position.x):l===1?(i=s.position.y,t=r.position.y):l===2&&(i=s.position.z,t=r.position.z);var o=s.boundingRadius,n=r.boundingRadius,a=i+o,c=t-n;return c<a},e.prototype.autoDetectAxis=function(){for(var s=0,r=0,l=0,i=0,t=0,o=0,n=this.axisList,a=n.length,c=1/a,h=0;h!==a;h++){var u=n[h],d=u.position.x;s+=d,r+=d*d;var x=u.position.y;l+=x,i+=x*x;var f=u.position.z;t+=f,o+=f*f}var b=r-s*s*c,G=i-l*l*c,st=o-t*t*c;b>G?b>st?this.axisIndex=0:this.axisIndex=2:G>st?this.axisIndex=1:this.axisIndex=2},e.prototype.aabbQuery=function(s,r,l){l=l||[],this.dirty&&(this.sortList(),this.dirty=!1);var i=this.axisIndex,t="x";i===1&&(t="y"),i===2&&(t="z");var o=this.axisList;r.lowerBound[t],r.upperBound[t];for(var n=0;n<o.length;n++){var a=o[n];a.aabbNeedsUpdate&&a.computeAABB(),a.aabb.overlaps(r)&&l.push(a)}return l}},{"../collision/Broadphase":5,"../shapes/Shape":43}],12:[function(v,V,et){V.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/ConeEquation"),s=v("../equations/RotationalEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6,a=o.pivotA?o.pivotA.clone():new r,c=o.pivotB?o.pivotB.clone():new r;this.axisA=o.axisA?o.axisA.clone():new r,this.axisB=o.axisB?o.axisB.clone():new r,p.call(this,i,a,t,c,n),this.collideConnected=!!o.collideConnected,this.angle=typeof o.angle<"u"?o.angle:0;var h=this.coneEquation=new e(i,t,o),u=this.twistEquation=new s(i,t,o);this.twistAngle=typeof o.twistAngle<"u"?o.twistAngle:0,h.maxForce=0,h.minForce=-n,u.maxForce=0,u.minForce=-n,this.equations.push(h,u)}l.prototype=new p,l.constructor=l,new r,new r,l.prototype.update=function(){var i=this.bodyA,t=this.bodyB,o=this.coneEquation,n=this.twistEquation;p.prototype.update.call(this),i.vectorToWorldFrame(this.axisA,o.axisA),t.vectorToWorldFrame(this.axisB,o.axisB),this.axisA.tangents(n.axisA,n.axisA),i.vectorToWorldFrame(n.axisA,n.axisA),this.axisB.tangents(n.axisB,n.axisB),t.vectorToWorldFrame(n.axisB,n.axisB),o.angle=this.angle,n.maxAngle=this.twistAngle}},{"../equations/ConeEquation":18,"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],13:[function(v,V,et){V.exports=e;var p=v("../utils/Utils");function e(s,r,l){l=p.defaults(l,{collideConnected:!0,wakeUpBodies:!0}),this.equations=[],this.bodyA=s,this.bodyB=r,this.id=e.idCounter++,this.collideConnected=l.collideConnected,l.wakeUpBodies&&(s&&s.wakeUp(),r&&r.wakeUp())}e.prototype.update=function(){throw new Error("method update() not implmemented in this Constraint subclass!")},e.prototype.enable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!0},e.prototype.disable=function(){for(var s=this.equations,r=0;r<s.length;r++)s[r].enabled=!1},e.idCounter=0},{"../utils/Utils":53}],14:[function(v,V,et){V.exports=s;var p=v("./Constraint"),e=v("../equations/ContactEquation");function s(r,l,i,t){p.call(this,r,l),typeof i>"u"&&(i=r.position.distanceTo(l.position)),typeof t>"u"&&(t=1e6),this.distance=i;var o=this.distanceEquation=new e(r,l);this.equations.push(o),o.minForce=-t,o.maxForce=t}s.prototype=new p,s.prototype.update=function(){var r=this.bodyA,l=this.bodyB,i=this.distanceEquation,t=this.distance*.5,o=i.ni;l.position.vsub(r.position,o),o.normalize(),o.mult(t,i.ri),o.mult(-t,i.rj)}},{"../equations/ContactEquation":19,"./Constraint":13}],15:[function(v,V,et){V.exports=l,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation"),s=v("../equations/RotationalMotorEquation");v("../equations/ContactEquation");var r=v("../math/Vec3");function l(o,n,a){a=a||{};var c=typeof a.maxForce<"u"?a.maxForce:1e6,h=a.pivotA?a.pivotA.clone():new r,u=a.pivotB?a.pivotB.clone():new r;p.call(this,o,h,n,u,c);var d=this.axisA=a.axisA?a.axisA.clone():new r(1,0,0);d.normalize();var x=this.axisB=a.axisB?a.axisB.clone():new r(1,0,0);x.normalize();var f=this.rotationalEquation1=new e(o,n,a),b=this.rotationalEquation2=new e(o,n,a),G=this.motorEquation=new s(o,n,c);G.enabled=!1,this.equations.push(f,b,G)}l.prototype=new p,l.constructor=l,l.prototype.enableMotor=function(){this.motorEquation.enabled=!0},l.prototype.disableMotor=function(){this.motorEquation.enabled=!1},l.prototype.setMotorSpeed=function(o){this.motorEquation.targetVelocity=o},l.prototype.setMotorMaxForce=function(o){this.motorEquation.maxForce=o,this.motorEquation.minForce=-o};var i=new r,t=new r;l.prototype.update=function(){var o=this.bodyA,n=this.bodyB,a=this.motorEquation,c=this.rotationalEquation1,h=this.rotationalEquation2,u=i,d=t,x=this.axisA,f=this.axisB;p.prototype.update.call(this),o.quaternion.vmult(x,u),n.quaternion.vmult(f,d),u.tangents(c.axisA,h.axisA),c.axisB.copy(d),h.axisB.copy(d),this.motorEquation.enabled&&(o.quaternion.vmult(this.axisA,a.axisA),n.quaternion.vmult(this.axisB,a.axisB))}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],16:[function(v,V,et){V.exports=r,v("./Constraint");var p=v("./PointToPointConstraint"),e=v("../equations/RotationalEquation");v("../equations/RotationalMotorEquation"),v("../equations/ContactEquation");var s=v("../math/Vec3");function r(l,i,t){t=t||{};var o=typeof t.maxForce<"u"?t.maxForce:1e6,n=new s,a=new s,c=new s;l.position.vadd(i.position,c),c.scale(.5,c),i.pointToLocalFrame(c,a),l.pointToLocalFrame(c,n),p.call(this,l,n,i,a,o);var h=this.rotationalEquation1=new e(l,i,t),u=this.rotationalEquation2=new e(l,i,t),d=this.rotationalEquation3=new e(l,i,t);this.equations.push(h,u,d)}r.prototype=new p,r.constructor=r,new s,new s,r.prototype.update=function(){var l=this.bodyA,i=this.bodyB;this.motorEquation;var t=this.rotationalEquation1,o=this.rotationalEquation2,n=this.rotationalEquation3;p.prototype.update.call(this),l.vectorToWorldFrame(s.UNIT_X,t.axisA),i.vectorToWorldFrame(s.UNIT_Y,t.axisB),l.vectorToWorldFrame(s.UNIT_Y,o.axisA),i.vectorToWorldFrame(s.UNIT_Z,o.axisB),l.vectorToWorldFrame(s.UNIT_Z,n.axisA),i.vectorToWorldFrame(s.UNIT_X,n.axisB)}},{"../equations/ContactEquation":19,"../equations/RotationalEquation":22,"../equations/RotationalMotorEquation":23,"../math/Vec3":30,"./Constraint":13,"./PointToPointConstraint":17}],17:[function(v,V,et){V.exports=r;var p=v("./Constraint"),e=v("../equations/ContactEquation"),s=v("../math/Vec3");function r(l,i,t,o,n){p.call(this,l,t),n=typeof n<"u"?n:1e6,this.pivotA=i?i.clone():new s,this.pivotB=o?o.clone():new s;var a=this.equationX=new e(l,t),c=this.equationY=new e(l,t),h=this.equationZ=new e(l,t);this.equations.push(a,c,h),a.minForce=c.minForce=h.minForce=-n,a.maxForce=c.maxForce=h.maxForce=n,a.ni.set(1,0,0),c.ni.set(0,1,0),h.ni.set(0,0,1)}r.prototype=new p,r.prototype.update=function(){var l=this.bodyA,i=this.bodyB,t=this.equationX,o=this.equationY,n=this.equationZ;l.quaternion.vmult(this.pivotA,t.ri),i.quaternion.vmult(this.pivotB,t.rj),o.ri.copy(t.ri),o.rj.copy(t.rj),n.ri.copy(t.ri),n.rj.copy(t.rj)}},{"../equations/ContactEquation":19,"../math/Vec3":30,"./Constraint":13}],18:[function(v,V,et){V.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6;e.call(this,i,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new p(1,0,0),this.axisB=o.axisB?o.axisB.clone():new p(0,1,0),this.angle=typeof o.angle<"u"?o.angle:0}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(i){var t=this.a,o=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.angle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),G=-x*t-f*o-i*b;return G}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],19:[function(v,V,et){V.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(h,u,d){d=typeof d<"u"?d:1e6,p.call(this,h,u,0,d),this.restitution=0,this.ri=new e,this.rj=new e,this.ni=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e,i=new e;s.prototype.computeB=function(h){var u=this.a,d=this.b,x=this.bi,f=this.bj,b=this.ri,G=this.rj,st=r,T=l,k=x.velocity,M=x.angularVelocity;x.force,x.torque;var B=f.velocity,N=f.angularVelocity;f.force,f.torque;var F=i,j=this.jacobianElementA,K=this.jacobianElementB,pt=this.ni;b.cross(pt,st),G.cross(pt,T),pt.negate(j.spatial),st.negate(j.rotational),K.spatial.copy(pt),K.rotational.copy(T),F.copy(f.position),F.vadd(G,F),F.vsub(x.position,F),F.vsub(b,F);var z=pt.dot(F),E=this.restitution+1,Y=E*B.dot(pt)-E*k.dot(pt)+N.dot(T)-M.dot(st),q=this.computeGiMf(),g=-z*u-Y*d-h*q;return g};var t=new e,o=new e,n=new e,a=new e,c=new e;s.prototype.getImpactVelocityAlongNormal=function(){var h=t,u=o,d=n,x=a,f=c;return this.bi.position.vadd(this.ri,d),this.bj.position.vadd(this.rj,x),this.bi.getVelocityAtWorldPoint(d,h),this.bj.getVelocityAtWorldPoint(x,u),h.vsub(u,f),this.ni.dot(f)}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],20:[function(v,V,et){V.exports=s;var p=v("../math/JacobianElement"),e=v("../math/Vec3");function s(c,h,u,d){this.id=s.id++,this.minForce=typeof u>"u"?-1e6:u,this.maxForce=typeof d>"u"?1e6:d,this.bi=c,this.bj=h,this.a=0,this.b=0,this.eps=0,this.jacobianElementA=new p,this.jacobianElementB=new p,this.enabled=!0,this.setSpookParams(1e7,4,1/60)}s.prototype.constructor=s,s.id=0,s.prototype.setSpookParams=function(c,h,u){var d=h,x=c,f=u;this.a=4/(f*(1+4*d)),this.b=4*d/(1+4*d),this.eps=4/(f*f*x*(1+4*d))},s.prototype.computeB=function(c,h,u){var d=this.computeGW(),x=this.computeGq(),f=this.computeGiMf();return-x*c-d*h-f*u},s.prototype.computeGq=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.position,f=d.position;return c.spatial.dot(x)+h.spatial.dot(f)};var r=new e;s.prototype.computeGW=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.velocity,f=d.velocity,b=u.angularVelocity||r,G=d.angularVelocity||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,G)},s.prototype.computeGWlambda=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.vlambda,f=d.vlambda,b=u.wlambda||r,G=d.wlambda||r;return c.multiplyVectors(x,b)+h.multiplyVectors(f,G)};var l=new e,i=new e,t=new e,o=new e;s.prototype.computeGiMf=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.force,f=u.torque,b=d.force,G=d.torque,st=u.invMassSolve,T=d.invMassSolve;return u.invInertiaWorldSolve?u.invInertiaWorldSolve.vmult(f,t):t.set(0,0,0),d.invInertiaWorldSolve?d.invInertiaWorldSolve.vmult(G,o):o.set(0,0,0),x.mult(st,l),b.mult(T,i),c.multiplyVectors(l,t)+h.multiplyVectors(i,o)};var n=new e;s.prototype.computeGiMGt=function(){var c=this.jacobianElementA,h=this.jacobianElementB,u=this.bi,d=this.bj,x=u.invMassSolve,f=d.invMassSolve,b=u.invInertiaWorldSolve,G=d.invInertiaWorldSolve,st=x+f;return b&&(b.vmult(c.rotational,n),st+=n.dot(c.rotational)),G&&(G.vmult(h.rotational,n),st+=n.dot(h.rotational)),st};var a=new e;new e,new e,new e,new e,new e,s.prototype.addToWlambda=function(c){var h=this.jacobianElementA,u=this.jacobianElementB,d=this.bi,x=this.bj,f=a;h.spatial.mult(d.invMassSolve*c,f),d.vlambda.vadd(f,d.vlambda),u.spatial.mult(x.invMassSolve*c,f),x.vlambda.vadd(f,x.vlambda),d.invInertiaWorldSolve&&(d.invInertiaWorldSolve.vmult(h.rotational,f),f.mult(c,f),d.wlambda.vadd(f,d.wlambda)),x.invInertiaWorldSolve&&(x.invInertiaWorldSolve.vmult(u.rotational,f),f.mult(c,f),x.wlambda.vadd(f,x.wlambda))},s.prototype.computeC=function(){return this.computeGiMGt()+this.eps}},{"../math/JacobianElement":26,"../math/Vec3":30}],21:[function(v,V,et){V.exports=s;var p=v("./Equation"),e=v("../math/Vec3");v("../math/Mat3");function s(i,t,o){p.call(this,i,t,-o,o),this.ri=new e,this.rj=new e,this.t=new e}s.prototype=new p,s.prototype.constructor=s;var r=new e,l=new e;s.prototype.computeB=function(i){this.a;var t=this.b;this.bi,this.bj;var o=this.ri,n=this.rj,a=r,c=l,h=this.t;o.cross(h,a),n.cross(h,c);var u=this.jacobianElementA,d=this.jacobianElementB;h.negate(u.spatial),a.negate(u.rotational),d.spatial.copy(h),d.rotational.copy(c);var x=this.computeGW(),f=this.computeGiMf(),b=-x*t-i*f;return b}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],22:[function(v,V,et){V.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(i,t,o){o=o||{};var n=typeof o.maxForce<"u"?o.maxForce:1e6;e.call(this,i,t,-n,n),this.axisA=o.axisA?o.axisA.clone():new p(1,0,0),this.axisB=o.axisB?o.axisB.clone():new p(0,1,0),this.maxAngle=Math.PI/2}s.prototype=new e,s.prototype.constructor=s;var r=new p,l=new p;s.prototype.computeB=function(i){var t=this.a,o=this.b,n=this.axisA,a=this.axisB,c=r,h=l,u=this.jacobianElementA,d=this.jacobianElementB;n.cross(a,c),a.cross(n,h),u.rotational.copy(h),d.rotational.copy(c);var x=Math.cos(this.maxAngle)-n.dot(a),f=this.computeGW(),b=this.computeGiMf(),G=-x*t-f*o-i*b;return G}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],23:[function(v,V,et){V.exports=s;var p=v("../math/Vec3");v("../math/Mat3");var e=v("./Equation");function s(r,l,i){i=typeof i<"u"?i:1e6,e.call(this,r,l,-i,i),this.axisA=new p,this.axisB=new p,this.targetVelocity=0}s.prototype=new e,s.prototype.constructor=s,s.prototype.computeB=function(r){this.a;var l=this.b;this.bi,this.bj;var i=this.axisA,t=this.axisB,o=this.jacobianElementA,n=this.jacobianElementB;o.rotational.copy(i),t.negate(n.rotational);var a=this.computeGW()-this.targetVelocity,c=this.computeGiMf(),h=-a*l-r*c;return h}},{"../math/Mat3":27,"../math/Vec3":30,"./Equation":20}],24:[function(v,V,et){var p=v("../utils/Utils");V.exports=e;function e(s,r,l){l=p.defaults(l,{friction:.3,restitution:.3,contactEquationStiffness:1e7,contactEquationRelaxation:3,frictionEquationStiffness:1e7,frictionEquationRelaxation:3}),this.id=e.idCounter++,this.materials=[s,r],this.friction=l.friction,this.restitution=l.restitution,this.contactEquationStiffness=l.contactEquationStiffness,this.contactEquationRelaxation=l.contactEquationRelaxation,this.frictionEquationStiffness=l.frictionEquationStiffness,this.frictionEquationRelaxation=l.frictionEquationRelaxation}e.idCounter=0},{"../utils/Utils":53}],25:[function(v,V,et){V.exports=p;function p(e){var s="";e=e||{},typeof e=="string"?(s=e,e={}):typeof e=="object"&&(s=""),this.name=s,this.id=p.idCounter++,this.friction=typeof e.friction<"u"?e.friction:-1,this.restitution=typeof e.restitution<"u"?e.restitution:-1}p.idCounter=0},{}],26:[function(v,V,et){V.exports=e;var p=v("./Vec3");function e(){this.spatial=new p,this.rotational=new p}e.prototype.multiplyElement=function(s){return s.spatial.dot(this.spatial)+s.rotational.dot(this.rotational)},e.prototype.multiplyVectors=function(s,r){return s.dot(this.spatial)+r.dot(this.rotational)}},{"./Vec3":30}],27:[function(v,V,et){V.exports=e;var p=v("./Vec3");function e(s){s?this.elements=s:this.elements=[0,0,0,0,0,0,0,0,0]}e.prototype.identity=function(){var s=this.elements;s[0]=1,s[1]=0,s[2]=0,s[3]=0,s[4]=1,s[5]=0,s[6]=0,s[7]=0,s[8]=1},e.prototype.setZero=function(){var s=this.elements;s[0]=0,s[1]=0,s[2]=0,s[3]=0,s[4]=0,s[5]=0,s[6]=0,s[7]=0,s[8]=0},e.prototype.setTrace=function(s){var r=this.elements;r[0]=s.x,r[4]=s.y,r[8]=s.z},e.prototype.getTrace=function(r){var r=r||new p,l=this.elements;r.x=l[0],r.y=l[4],r.z=l[8]},e.prototype.vmult=function(s,r){r=r||new p;var l=this.elements,i=s.x,t=s.y,o=s.z;return r.x=l[0]*i+l[1]*t+l[2]*o,r.y=l[3]*i+l[4]*t+l[5]*o,r.z=l[6]*i+l[7]*t+l[8]*o,r},e.prototype.smult=function(s){for(var r=0;r<this.elements.length;r++)this.elements[r]*=s},e.prototype.mmult=function(s,r){for(var l=r||new e,i=0;i<3;i++)for(var t=0;t<3;t++){for(var o=0,n=0;n<3;n++)o+=s.elements[i+n*3]*this.elements[n+t*3];l.elements[i+t*3]=o}return l},e.prototype.scale=function(s,r){r=r||new e;for(var l=this.elements,i=r.elements,t=0;t!==3;t++)i[3*t+0]=s.x*l[3*t+0],i[3*t+1]=s.y*l[3*t+1],i[3*t+2]=s.z*l[3*t+2];return r},e.prototype.solve=function(s,r){r=r||new p;for(var l=3,i=4,t=[],o=0;o<l*i;o++)t.push(0);var o,n;for(o=0;o<3;o++)for(n=0;n<3;n++)t[o+i*n]=this.elements[o+3*n];t[3+4*0]=s.x,t[3+4*1]=s.y,t[3+4*2]=s.z;var a=3,c=a,h,u=4,d;do{if(o=c-a,t[o+i*o]===0){for(n=o+1;n<c;n++)if(t[o+i*n]!==0){h=u;do d=u-h,t[d+i*o]+=t[d+i*n];while(--h);break}}if(t[o+i*o]!==0)for(n=o+1;n<c;n++){var x=t[o+i*n]/t[o+i*o];h=u;do d=u-h,t[d+i*n]=d<=o?0:t[d+i*n]-t[d+i*o]*x;while(--h)}}while(--a);if(r.z=t[2*i+3]/t[2*i+2],r.y=(t[1*i+3]-t[1*i+2]*r.z)/t[1*i+1],r.x=(t[0*i+3]-t[0*i+2]*r.z-t[0*i+1]*r.y)/t[0*i+0],isNaN(r.x)||isNaN(r.y)||isNaN(r.z)||r.x===1/0||r.y===1/0||r.z===1/0)throw"Could not solve equation! Got x=["+r.toString()+"], b=["+s.toString()+"], A=["+this.toString()+"]";return r},e.prototype.e=function(s,r,l){if(l===void 0)return this.elements[r+3*s];this.elements[r+3*s]=l},e.prototype.copy=function(s){for(var r=0;r<s.elements.length;r++)this.elements[r]=s.elements[r];return this},e.prototype.toString=function(){for(var s="",r=",",l=0;l<9;l++)s+=this.elements[l]+r;return s},e.prototype.reverse=function(s){s=s||new e;for(var r=3,l=6,i=[],t=0;t<r*l;t++)i.push(0);var t,o;for(t=0;t<3;t++)for(o=0;o<3;o++)i[t+l*o]=this.elements[t+3*o];i[3+6*0]=1,i[3+6*1]=0,i[3+6*2]=0,i[4+6*0]=0,i[4+6*1]=1,i[4+6*2]=0,i[5+6*0]=0,i[5+6*1]=0,i[5+6*2]=1;var n=3,a=n,c,h=l,u;do{if(t=a-n,i[t+l*t]===0){for(o=t+1;o<a;o++)if(i[t+l*o]!==0){c=h;do u=h-c,i[u+l*t]+=i[u+l*o];while(--c);break}}if(i[t+l*t]!==0)for(o=t+1;o<a;o++){var d=i[t+l*o]/i[t+l*t];c=h;do u=h-c,i[u+l*o]=u<=t?0:i[u+l*o]-i[u+l*t]*d;while(--c)}}while(--n);t=2;do{o=t-1;do{var d=i[t+l*o]/i[t+l*t];c=l;do u=l-c,i[u+l*o]=i[u+l*o]-i[u+l*t]*d;while(--c)}while(o--)}while(--t);t=2;do{var d=1/i[t+l*t];c=l;do u=l-c,i[u+l*t]=i[u+l*t]*d;while(--c)}while(t--);t=2;do{o=2;do{if(u=i[r+o+l*t],isNaN(u)||u===1/0)throw"Could not reverse! A=["+this.toString()+"]";s.e(t,o,u)}while(o--)}while(t--);return s},e.prototype.setRotationFromQuaternion=function(s){var r=s.x,l=s.y,i=s.z,t=s.w,o=r+r,n=l+l,a=i+i,c=r*o,h=r*n,u=r*a,d=l*n,x=l*a,f=i*a,b=t*o,G=t*n,st=t*a,T=this.elements;return T[3*0+0]=1-(d+f),T[3*0+1]=h-st,T[3*0+2]=u+G,T[3*1+0]=h+st,T[3*1+1]=1-(c+f),T[3*1+2]=x-b,T[3*2+0]=u-G,T[3*2+1]=x+b,T[3*2+2]=1-(c+d),this},e.prototype.transpose=function(s){s=s||new e;for(var r=s.elements,l=this.elements,i=0;i!==3;i++)for(var t=0;t!==3;t++)r[3*i+t]=l[3*t+i];return s}},{"./Vec3":30}],28:[function(v,V,et){V.exports=e;var p=v("./Vec3");function e(o,n,a,c){this.x=o!==void 0?o:0,this.y=n!==void 0?n:0,this.z=a!==void 0?a:0,this.w=c!==void 0?c:1}e.prototype.set=function(o,n,a,c){this.x=o,this.y=n,this.z=a,this.w=c},e.prototype.toString=function(){return this.x+","+this.y+","+this.z+","+this.w},e.prototype.toArray=function(){return[this.x,this.y,this.z,this.w]},e.prototype.setFromAxisAngle=function(o,n){var a=Math.sin(n*.5);this.x=o.x*a,this.y=o.y*a,this.z=o.z*a,this.w=Math.cos(n*.5)},e.prototype.toAxisAngle=function(o){o=o||new p,this.normalize();var n=2*Math.acos(this.w),a=Math.sqrt(1-this.w*this.w);return a<.001?(o.x=this.x,o.y=this.y,o.z=this.z):(o.x=this.x/a,o.y=this.y/a,o.z=this.z/a),[o,n]};var s=new p,r=new p;e.prototype.setFromVectors=function(o,n){if(o.isAntiparallelTo(n)){var a=s,c=r;o.tangents(a,c),this.setFromAxisAngle(a,Math.PI)}else{var h=o.cross(n);this.x=h.x,this.y=h.y,this.z=h.z,this.w=Math.sqrt(Math.pow(o.norm(),2)*Math.pow(n.norm(),2))+o.dot(n),this.normalize()}};var l=new p,i=new p,t=new p;e.prototype.mult=function(o,n){n=n||new e;var a=this.w,c=l,h=i,u=t;return c.set(this.x,this.y,this.z),h.set(o.x,o.y,o.z),n.w=a*o.w-c.dot(h),c.cross(h,u),n.x=a*h.x+o.w*c.x+u.x,n.y=a*h.y+o.w*c.y+u.y,n.z=a*h.z+o.w*c.z+u.z,n},e.prototype.inverse=function(o){var n=this.x,a=this.y,c=this.z,h=this.w;o=o||new e,this.conjugate(o);var u=1/(n*n+a*a+c*c+h*h);return o.x*=u,o.y*=u,o.z*=u,o.w*=u,o},e.prototype.conjugate=function(o){return o=o||new e,o.x=-this.x,o.y=-this.y,o.z=-this.z,o.w=this.w,o},e.prototype.normalize=function(){var o=Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(o=1/o,this.x*=o,this.y*=o,this.z*=o,this.w*=o)},e.prototype.normalizeFast=function(){var o=(3-(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w))/2;o===0?(this.x=0,this.y=0,this.z=0,this.w=0):(this.x*=o,this.y*=o,this.z*=o,this.w*=o)},e.prototype.vmult=function(o,n){n=n||new p;var a=o.x,c=o.y,h=o.z,u=this.x,d=this.y,x=this.z,f=this.w,b=f*a+d*h-x*c,G=f*c+x*a-u*h,st=f*h+u*c-d*a,T=-u*a-d*c-x*h;return n.x=b*f+T*-u+G*-x-st*-d,n.y=G*f+T*-d+st*-u-b*-x,n.z=st*f+T*-x+b*-d-G*-u,n},e.prototype.copy=function(o){return this.x=o.x,this.y=o.y,this.z=o.z,this.w=o.w,this},e.prototype.toEuler=function(o,n){n=n||"YZX";var a,c,h,u=this.x,d=this.y,x=this.z,f=this.w;switch(n){case"YZX":var b=u*d+x*f;if(b>.499&&(a=2*Math.atan2(u,f),c=Math.PI/2,h=0),b<-.499&&(a=-2*Math.atan2(u,f),c=-Math.PI/2,h=0),isNaN(a)){var G=u*u,st=d*d,T=x*x;a=Math.atan2(2*d*f-2*u*x,1-2*st-2*T),c=Math.asin(2*b),h=Math.atan2(2*u*f-2*d*x,1-2*G-2*T)}break;default:throw new Error("Euler order "+n+" not supported yet.")}o.y=a,o.z=c,o.x=h},e.prototype.setFromEuler=function(o,n,a,c){c=c||"XYZ";var h=Math.cos(o/2),u=Math.cos(n/2),d=Math.cos(a/2),x=Math.sin(o/2),f=Math.sin(n/2),b=Math.sin(a/2);return c==="XYZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="YXZ"?(this.x=x*u*d+h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="ZXY"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d-x*f*b):c==="ZYX"?(this.x=x*u*d-h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d+x*f*b):c==="YZX"?(this.x=x*u*d+h*f*b,this.y=h*f*d+x*u*b,this.z=h*u*b-x*f*d,this.w=h*u*d-x*f*b):c==="XZY"&&(this.x=x*u*d-h*f*b,this.y=h*f*d-x*u*b,this.z=h*u*b+x*f*d,this.w=h*u*d+x*f*b),this},e.prototype.clone=function(){return new e(this.x,this.y,this.z,this.w)}},{"./Vec3":30}],29:[function(v,V,et){var p=v("./Vec3"),e=v("./Quaternion");V.exports=s;function s(l){l=l||{},this.position=new p,l.position&&this.position.copy(l.position),this.quaternion=new e,l.quaternion&&this.quaternion.copy(l.quaternion)}var r=new e;s.pointToLocalFrame=function(l,i,t,n){var n=n||new p;return t.vsub(l,n),i.conjugate(r),r.vmult(n,n),n},s.prototype.pointToLocal=function(l,i){return s.pointToLocalFrame(this.position,this.quaternion,l,i)},s.pointToWorldFrame=function(l,i,t,n){var n=n||new p;return i.vmult(t,n),n.vadd(l,n),n},s.prototype.pointToWorld=function(l,i){return s.pointToWorldFrame(this.position,this.quaternion,l,i)},s.prototype.vectorToWorldFrame=function(l,t){var t=t||new p;return this.quaternion.vmult(l,t),t},s.vectorToWorldFrame=function(l,i,t){return l.vmult(i,t),t},s.vectorToLocalFrame=function(l,i,t,n){var n=n||new p;return i.w*=-1,i.vmult(t,n),i.w*=-1,n}},{"./Quaternion":28,"./Vec3":30}],30:[function(v,V,et){V.exports=e;var p=v("./Mat3");function e(i,t,o){this.x=i||0,this.y=t||0,this.z=o||0}e.ZERO=new e(0,0,0),e.UNIT_X=new e(1,0,0),e.UNIT_Y=new e(0,1,0),e.UNIT_Z=new e(0,0,1),e.prototype.cross=function(i,t){var o=i.x,n=i.y,a=i.z,c=this.x,h=this.y,u=this.z;return t=t||new e,t.x=h*a-u*n,t.y=u*o-c*a,t.z=c*n-h*o,t},e.prototype.set=function(i,t,o){return this.x=i,this.y=t,this.z=o,this},e.prototype.setZero=function(){this.x=this.y=this.z=0},e.prototype.vadd=function(i,t){if(t)t.x=i.x+this.x,t.y=i.y+this.y,t.z=i.z+this.z;else return new e(this.x+i.x,this.y+i.y,this.z+i.z)},e.prototype.vsub=function(i,t){if(t)t.x=this.x-i.x,t.y=this.y-i.y,t.z=this.z-i.z;else return new e(this.x-i.x,this.y-i.y,this.z-i.z)},e.prototype.crossmat=function(){return new p([0,-this.z,this.y,this.z,0,-this.x,-this.y,this.x,0])},e.prototype.normalize=function(){var i=this.x,t=this.y,o=this.z,n=Math.sqrt(i*i+t*t+o*o);if(n>0){var a=1/n;this.x*=a,this.y*=a,this.z*=a}else this.x=0,this.y=0,this.z=0;return n},e.prototype.unit=function(i){i=i||new e;var t=this.x,o=this.y,n=this.z,a=Math.sqrt(t*t+o*o+n*n);return a>0?(a=1/a,i.x=t*a,i.y=o*a,i.z=n*a):(i.x=1,i.y=0,i.z=0),i},e.prototype.norm=function(){var i=this.x,t=this.y,o=this.z;return Math.sqrt(i*i+t*t+o*o)},e.prototype.length=e.prototype.norm,e.prototype.norm2=function(){return this.dot(this)},e.prototype.lengthSquared=e.prototype.norm2,e.prototype.distanceTo=function(i){var t=this.x,o=this.y,n=this.z,a=i.x,c=i.y,h=i.z;return Math.sqrt((a-t)*(a-t)+(c-o)*(c-o)+(h-n)*(h-n))},e.prototype.distanceSquared=function(i){var t=this.x,o=this.y,n=this.z,a=i.x,c=i.y,h=i.z;return(a-t)*(a-t)+(c-o)*(c-o)+(h-n)*(h-n)},e.prototype.mult=function(i,t){t=t||new e;var o=this.x,n=this.y,a=this.z;return t.x=i*o,t.y=i*n,t.z=i*a,t},e.prototype.scale=e.prototype.mult,e.prototype.dot=function(i){return this.x*i.x+this.y*i.y+this.z*i.z},e.prototype.isZero=function(){return this.x===0&&this.y===0&&this.z===0},e.prototype.negate=function(i){return i=i||new e,i.x=-this.x,i.y=-this.y,i.z=-this.z,i};var s=new e,r=new e;e.prototype.tangents=function(i,t){var o=this.norm();if(o>0){var n=s,a=1/o;n.set(this.x*a,this.y*a,this.z*a);var c=r;Math.abs(n.x)<.9?(c.set(1,0,0),n.cross(c,i)):(c.set(0,1,0),n.cross(c,i)),n.cross(i,t)}else i.set(1,0,0),t.set(0,1,0)},e.prototype.toString=function(){return this.x+","+this.y+","+this.z},e.prototype.toArray=function(){return[this.x,this.y,this.z]},e.prototype.copy=function(i){return this.x=i.x,this.y=i.y,this.z=i.z,this},e.prototype.lerp=function(i,t,o){var n=this.x,a=this.y,c=this.z;o.x=n+(i.x-n)*t,o.y=a+(i.y-a)*t,o.z=c+(i.z-c)*t},e.prototype.almostEquals=function(i,t){return t===void 0&&(t=1e-6),!(Math.abs(this.x-i.x)>t||Math.abs(this.y-i.y)>t||Math.abs(this.z-i.z)>t)},e.prototype.almostZero=function(i){return i===void 0&&(i=1e-6),!(Math.abs(this.x)>i||Math.abs(this.y)>i||Math.abs(this.z)>i)};var l=new e;e.prototype.isAntiparallelTo=function(i,t){return this.negate(l),l.almostEquals(i,t)},e.prototype.clone=function(){return new e(this.x,this.y,this.z)}},{"./Mat3":27}],31:[function(v,V,et){V.exports=t;var p=v("../utils/EventTarget");v("../shapes/Shape");var e=v("../math/Vec3"),s=v("../math/Mat3"),r=v("../math/Quaternion");v("../material/Material");var l=v("../collision/AABB"),i=v("../shapes/Box");function t(B){B=B||{},p.apply(this),this.id=t.idCounter++,this.world=null,this.preStep=null,this.postStep=null,this.vlambda=new e,this.collisionFilterGroup=typeof B.collisionFilterGroup=="number"?B.collisionFilterGroup:1,this.collisionFilterMask=typeof B.collisionFilterMask=="number"?B.collisionFilterMask:1,this.collisionResponse=!0,this.position=new e,B.position&&this.position.copy(B.position),this.previousPosition=new e,this.initPosition=new e,this.velocity=new e,B.velocity&&this.velocity.copy(B.velocity),this.initVelocity=new e,this.force=new e;var N=typeof B.mass=="number"?B.mass:0;this.mass=N,this.invMass=N>0?1/N:0,this.material=B.material||null,this.linearDamping=typeof B.linearDamping=="number"?B.linearDamping:.01,this.type=N<=0?t.STATIC:t.DYNAMIC,typeof B.type==typeof t.STATIC&&(this.type=B.type),this.allowSleep=typeof B.allowSleep<"u"?B.allowSleep:!0,this.sleepState=0,this.sleepSpeedLimit=typeof B.sleepSpeedLimit<"u"?B.sleepSpeedLimit:.1,this.sleepTimeLimit=typeof B.sleepTimeLimit<"u"?B.sleepTimeLimit:1,this.timeLastSleepy=0,this._wakeUpAfterNarrowphase=!1,this.torque=new e,this.quaternion=new r,B.quaternion&&this.quaternion.copy(B.quaternion),this.initQuaternion=new r,this.angularVelocity=new e,B.angularVelocity&&this.angularVelocity.copy(B.angularVelocity),this.initAngularVelocity=new e,this.interpolatedPosition=new e,this.interpolatedQuaternion=new r,this.shapes=[],this.shapeOffsets=[],this.shapeOrientations=[],this.inertia=new e,this.invInertia=new e,this.invInertiaWorld=new s,this.invMassSolve=0,this.invInertiaSolve=new e,this.invInertiaWorldSolve=new s,this.fixedRotation=typeof B.fixedRotation<"u"?B.fixedRotation:!1,this.angularDamping=typeof B.angularDamping<"u"?B.angularDamping:.01,this.aabb=new l,this.aabbNeedsUpdate=!0,this.wlambda=new e,B.shape&&this.addShape(B.shape),this.updateMassProperties()}t.prototype=new p,t.prototype.constructor=t,t.DYNAMIC=1,t.STATIC=2,t.KINEMATIC=4,t.AWAKE=0,t.SLEEPY=1,t.SLEEPING=2,t.idCounter=0,t.prototype.wakeUp=function(){var B=this.sleepState;this.sleepState=0,B===t.SLEEPING&&this.dispatchEvent({type:"wakeup"})},t.prototype.sleep=function(){this.sleepState=t.SLEEPING,this.velocity.set(0,0,0),this.angularVelocity.set(0,0,0)},t.sleepyEvent={type:"sleepy"},t.sleepEvent={type:"sleep"},t.prototype.sleepTick=function(B){if(this.allowSleep){var N=this.sleepState,F=this.velocity.norm2()+this.angularVelocity.norm2(),j=Math.pow(this.sleepSpeedLimit,2);N===t.AWAKE&&F<j?(this.sleepState=t.SLEEPY,this.timeLastSleepy=B,this.dispatchEvent(t.sleepyEvent)):N===t.SLEEPY&&F>j?this.wakeUp():N===t.SLEEPY&&B-this.timeLastSleepy>this.sleepTimeLimit&&(this.sleep(),this.dispatchEvent(t.sleepEvent))}},t.prototype.updateSolveMassProperties=function(){this.sleepState===t.SLEEPING||this.type===t.KINEMATIC?(this.invMassSolve=0,this.invInertiaSolve.setZero(),this.invInertiaWorldSolve.setZero()):(this.invMassSolve=this.invMass,this.invInertiaSolve.copy(this.invInertia),this.invInertiaWorldSolve.copy(this.invInertiaWorld))},t.prototype.pointToLocalFrame=function(B,F){var F=F||new e;return B.vsub(this.position,F),this.quaternion.conjugate().vmult(F,F),F},t.prototype.vectorToLocalFrame=function(B,F){var F=F||new e;return this.quaternion.conjugate().vmult(B,F),F},t.prototype.pointToWorldFrame=function(B,F){var F=F||new e;return this.quaternion.vmult(B,F),F.vadd(this.position,F),F},t.prototype.vectorToWorldFrame=function(B,F){var F=F||new e;return this.quaternion.vmult(B,F),F};var o=new e,n=new r;t.prototype.addShape=function(B,N,F){var j=new e,K=new r;return N&&j.copy(N),F&&K.copy(F),this.shapes.push(B),this.shapeOffsets.push(j),this.shapeOrientations.push(K),this.updateMassProperties(),this.updateBoundingRadius(),this.aabbNeedsUpdate=!0,this},t.prototype.updateBoundingRadius=function(){for(var B=this.shapes,N=this.shapeOffsets,F=B.length,j=0,K=0;K!==F;K++){var pt=B[K];pt.updateBoundingSphereRadius();var z=N[K].norm(),E=pt.boundingSphereRadius;z+E>j&&(j=z+E)}this.boundingRadius=j};var a=new l;t.prototype.computeAABB=function(){for(var B=this.shapes,N=this.shapeOffsets,F=this.shapeOrientations,j=B.length,K=o,pt=n,z=this.quaternion,E=this.aabb,Y=a,q=0;q!==j;q++){var g=B[q];F[q].mult(z,pt),pt.vmult(N[q],K),K.vadd(this.position,K),g.calculateWorldAABB(K,pt,Y.lowerBound,Y.upperBound),q===0?E.copy(Y):E.extend(Y)}this.aabbNeedsUpdate=!1};var c=new s,h=new s;new s,t.prototype.updateInertiaWorld=function(B){var N=this.invInertia;if(!(N.x===N.y&&N.y===N.z&&!B)){var F=c,j=h;F.setRotationFromQuaternion(this.quaternion),F.transpose(j),F.scale(N,F),F.mmult(j,this.invInertiaWorld)}};var u=new e,d=new e;t.prototype.applyForce=function(B,N){if(this.type===t.DYNAMIC){var F=u;N.vsub(this.position,F);var j=d;F.cross(B,j),this.force.vadd(B,this.force),this.torque.vadd(j,this.torque)}};var x=new e,f=new e;t.prototype.applyLocalForce=function(B,N){if(this.type===t.DYNAMIC){var F=x,j=f;this.vectorToWorldFrame(B,F),this.pointToWorldFrame(N,j),this.applyForce(F,j)}};var b=new e,G=new e,st=new e;t.prototype.applyImpulse=function(B,N){if(this.type===t.DYNAMIC){var F=b;N.vsub(this.position,F);var j=G;j.copy(B),j.mult(this.invMass,j),this.velocity.vadd(j,this.velocity);var K=st;F.cross(B,K),this.invInertiaWorld.vmult(K,K),this.angularVelocity.vadd(K,this.angularVelocity)}};var T=new e,k=new e;t.prototype.applyLocalImpulse=function(B,N){if(this.type===t.DYNAMIC){var F=T,j=k;this.vectorToWorldFrame(B,F),this.pointToWorldFrame(N,j),this.applyImpulse(F,j)}};var M=new e;t.prototype.updateMassProperties=function(){var B=M;this.invMass=this.mass>0?1/this.mass:0;var N=this.inertia,F=this.fixedRotation;this.computeAABB(),B.set((this.aabb.upperBound.x-this.aabb.lowerBound.x)/2,(this.aabb.upperBound.y-this.aabb.lowerBound.y)/2,(this.aabb.upperBound.z-this.aabb.lowerBound.z)/2),i.calculateInertia(B,this.mass,N),this.invInertia.set(N.x>0&&!F?1/N.x:0,N.y>0&&!F?1/N.y:0,N.z>0&&!F?1/N.z:0),this.updateInertiaWorld(!0)},t.prototype.getVelocityAtWorldPoint=function(B,N){var F=new e;return B.vsub(this.position,F),this.angularVelocity.cross(F,N),this.velocity.vadd(N,N),N}},{"../collision/AABB":3,"../material/Material":25,"../math/Mat3":27,"../math/Quaternion":28,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Shape":43,"../utils/EventTarget":49}],32:[function(v,V,et){v("./Body");var p=v("../math/Vec3"),e=v("../math/Quaternion");v("../collision/RaycastResult");var s=v("../collision/Ray"),r=v("../objects/WheelInfo");V.exports=l;function l(z){this.chassisBody=z.chassisBody,this.wheelInfos=[],this.sliding=!1,this.world=null,this.indexRightAxis=typeof z.indexRightAxis<"u"?z.indexRightAxis:1,this.indexForwardAxis=typeof z.indexForwardAxis<"u"?z.indexForwardAxis:0,this.indexUpAxis=typeof z.indexUpAxis<"u"?z.indexUpAxis:2}new p,new p,new p;var i=new p,t=new p,o=new p;new s,l.prototype.addWheel=function(z){z=z||{};var E=new r(z),Y=this.wheelInfos.length;return this.wheelInfos.push(E),Y},l.prototype.setSteeringValue=function(z,E){var Y=this.wheelInfos[E];Y.steering=z},new p,l.prototype.applyEngineForce=function(z,E){this.wheelInfos[E].engineForce=z},l.prototype.setBrake=function(z,E){this.wheelInfos[E].brake=z},l.prototype.addToWorld=function(z){this.constraints,z.add(this.chassisBody);var E=this;this.preStepCallback=function(){E.updateVehicle(z.dt)},z.addEventListener("preStep",this.preStepCallback),this.world=z},l.prototype.getVehicleAxisWorld=function(z,E){E.set(z===0?1:0,z===1?1:0,z===2?1:0),this.chassisBody.vectorToWorldFrame(E,E)},l.prototype.updateVehicle=function(z){for(var E=this.wheelInfos,Y=E.length,q=this.chassisBody,g=0;g<Y;g++)this.updateWheelTransform(g);this.currentVehicleSpeedKmHour=3.6*q.velocity.norm();var R=new p;this.getVehicleAxisWorld(this.indexForwardAxis,R),R.dot(q.velocity)<0&&(this.currentVehicleSpeedKmHour*=-1);for(var g=0;g<Y;g++)this.castRay(E[g]);this.updateSuspension(z);for(var w=new p,m=new p,g=0;g<Y;g++){var y=E[g],C=y.suspensionForce;C>y.maxSuspensionForce&&(C=y.maxSuspensionForce),y.raycastResult.hitNormalWorld.scale(C*z,w),y.raycastResult.hitPointWorld.vsub(q.position,m),q.applyImpulse(w,y.raycastResult.hitPointWorld)}this.updateFriction(z);var H=new p,W=new p,A=new p;for(g=0;g<Y;g++){var y=E[g];q.getVelocityAtWorldPoint(y.chassisConnectionPointWorld,A);var L=1;switch(this.indexUpAxis){case 1:L=-1;break}if(y.isInContact){this.getVehicleAxisWorld(this.indexForwardAxis,W);var X=W.dot(y.raycastResult.hitNormalWorld);y.raycastResult.hitNormalWorld.scale(X,H),W.vsub(H,W);var ut=W.dot(A);y.deltaRotation=L*ut*z/y.radius}(y.sliding||!y.isInContact)&&y.engineForce!==0&&y.useCustomSlidingRotationalSpeed&&(y.deltaRotation=(y.engineForce>0?1:-1)*y.customSlidingRotationalSpeed*z),Math.abs(y.brake)>Math.abs(y.engineForce)&&(y.deltaRotation=0),y.rotation+=y.deltaRotation,y.deltaRotation*=.99}},l.prototype.updateSuspension=function(z){for(var E=this.chassisBody,Y=E.mass,q=this.wheelInfos,g=q.length,R=0;R<g;R++){var w=q[R];if(w.isInContact){var m,y=w.suspensionRestLength,C=w.suspensionLength,H=y-C;m=w.suspensionStiffness*H*w.clippedInvContactDotSuspension;var W=w.suspensionRelativeVelocity,A;W<0?A=w.dampingCompression:A=w.dampingRelaxation,m-=A*W,w.suspensionForce=m*Y,w.suspensionForce<0&&(w.suspensionForce=0)}else w.suspensionForce=0}},l.prototype.removeFromWorld=function(z){this.constraints,z.remove(this.chassisBody),z.removeEventListener("preStep",this.preStepCallback),this.world=null};var n=new p,a=new p;l.prototype.castRay=function(z){var E=n,Y=a;this.updateWheelTransformWorld(z);var q=this.chassisBody,g=-1,R=z.suspensionRestLength+z.radius;z.directionWorld.scale(R,E);var w=z.chassisConnectionPointWorld;w.vadd(E,Y);var m=z.raycastResult;m.reset();var y=q.collisionResponse;q.collisionResponse=!1,this.world.rayTest(w,Y,m),q.collisionResponse=y;var C=m.body;if(z.raycastResult.groundObject=0,C){g=m.distance,z.raycastResult.hitNormalWorld=m.hitNormalWorld,z.isInContact=!0;var H=m.distance;z.suspensionLength=H-z.radius;var W=z.suspensionRestLength-z.maxSuspensionTravel,A=z.suspensionRestLength+z.maxSuspensionTravel;z.suspensionLength<W&&(z.suspensionLength=W),z.suspensionLength>A&&(z.suspensionLength=A,z.raycastResult.reset());var L=z.raycastResult.hitNormalWorld.dot(z.directionWorld),X=new p;q.getVelocityAtWorldPoint(z.raycastResult.hitPointWorld,X);var ut=z.raycastResult.hitNormalWorld.dot(X);if(L>=-.1)z.suspensionRelativeVelocity=0,z.clippedInvContactDotSuspension=1/.1;else{var lt=-1/L;z.suspensionRelativeVelocity=ut*lt,z.clippedInvContactDotSuspension=lt}}else z.suspensionLength=z.suspensionRestLength+0*z.maxSuspensionTravel,z.suspensionRelativeVelocity=0,z.directionWorld.scale(-1,z.raycastResult.hitNormalWorld),z.clippedInvContactDotSuspension=1;return g},l.prototype.updateWheelTransformWorld=function(z){z.isInContact=!1;var E=this.chassisBody;E.pointToWorldFrame(z.chassisConnectionPointLocal,z.chassisConnectionPointWorld),E.vectorToWorldFrame(z.directionLocal,z.directionWorld),E.vectorToWorldFrame(z.axleLocal,z.axleWorld)},l.prototype.updateWheelTransform=function(z){var E=i,Y=t,q=o,g=this.wheelInfos[z];this.updateWheelTransformWorld(g),g.directionLocal.scale(-1,E),Y.copy(g.axleLocal),E.cross(Y,q),q.normalize(),Y.normalize();var R=g.steering,w=new e;w.setFromAxisAngle(E,R);var m=new e;m.setFromAxisAngle(Y,g.rotation);var y=g.worldTransform.quaternion;this.chassisBody.quaternion.mult(w,y),y.mult(m,y),y.normalize();var C=g.worldTransform.position;C.copy(g.directionWorld),C.scale(g.suspensionLength,C),C.vadd(g.chassisConnectionPointWorld,C)};var c=[new p(1,0,0),new p(0,1,0),new p(0,0,1)];l.prototype.getWheelTransformWorld=function(z){return this.wheelInfos[z].worldTransform};var h=new p,u=[],d=[],x=1;l.prototype.updateFriction=function(z){for(var E=h,Y=this.wheelInfos,q=Y.length,g=this.chassisBody,R=d,w=u,m=0;m<q;m++){var y=Y[m],C=y.raycastResult.body;y.sideImpulse=0,y.forwardImpulse=0,R[m]||(R[m]=new p),w[m]||(w[m]=new p)}for(var m=0;m<q;m++){var y=Y[m],C=y.raycastResult.body;if(C){var H=w[m],W=this.getWheelTransformWorld(m);W.vectorToWorldFrame(c[this.indexRightAxis],H);var A=y.raycastResult.hitNormalWorld,L=H.dot(A);A.scale(L,E),H.vsub(E,H),H.normalize(),A.cross(H,R[m]),R[m].normalize(),y.sideImpulse=pt(g,y.raycastResult.hitPointWorld,C,y.raycastResult.hitPointWorld,H),y.sideImpulse*=x}}var X=1,ut=.5;this.sliding=!1;for(var m=0;m<q;m++){var y=Y[m],C=y.raycastResult.body,lt=0;if(y.slipInfo=1,C){var at=0,O=y.brake?y.brake:at;lt=st(g,C,y.raycastResult.hitPointWorld,R[m],O),lt+=y.engineForce*z;var Q=O/lt;y.slipInfo*=Q}if(y.forwardImpulse=0,y.skidInfo=1,C){y.skidInfo=1;var bt=y.suspensionForce*z*y.frictionSlip,ft=bt,Pt=bt*ft;y.forwardImpulse=lt;var ct=y.forwardImpulse*ut,Mt=y.sideImpulse*X,zt=ct*ct+Mt*Mt;if(y.sliding=!1,zt>Pt){this.sliding=!0,y.sliding=!0;var Q=bt/Math.sqrt(zt);y.skidInfo*=Q}}}if(this.sliding)for(var m=0;m<q;m++){var y=Y[m];y.sideImpulse!==0&&y.skidInfo<1&&(y.forwardImpulse*=y.skidInfo,y.sideImpulse*=y.skidInfo)}for(var m=0;m<q;m++){var y=Y[m],Rt=new p;if(Rt.copy(y.raycastResult.hitPointWorld),y.forwardImpulse!==0){var Tt=new p;R[m].scale(y.forwardImpulse,Tt),g.applyImpulse(Tt,Rt)}if(y.sideImpulse!==0){var C=y.raycastResult.body,Et=new p;Et.copy(y.raycastResult.hitPointWorld);var Ft=new p;w[m].scale(y.sideImpulse,Ft),g.pointToLocalFrame(Rt,Rt),Rt["xyz"[this.indexUpAxis]]*=y.rollInfluence,g.pointToWorldFrame(Rt,Rt),g.applyImpulse(Ft,Rt),Ft.scale(-1,Ft),C.applyImpulse(Ft,Et)}}};var f=new p,b=new p,G=new p;function st(z,E,Y,q,g){var R=0,w=Y,m=f,y=b,C=G;z.getVelocityAtWorldPoint(w,m),E.getVelocityAtWorldPoint(w,y),m.vsub(y,C);var H=q.dot(C),W=N(z,Y,q),A=N(E,Y,q),L=1,X=L/(W+A);return R=-H*X,g<R&&(R=g),R<-g&&(R=-g),R}var T=new p,k=new p,M=new p,B=new p;function N(z,E,Y){var q=T,g=k,R=M,w=B;return E.vsub(z.position,q),q.cross(Y,g),z.invInertiaWorld.vmult(g,w),w.cross(q,R),z.invMass+Y.dot(R)}var F=new p,j=new p,K=new p;function pt(z,E,Y,q,g,L){var w=g.norm2();if(w>1.1)return 0;var m=F,y=j,C=K;z.getVelocityAtWorldPoint(E,m),Y.getVelocityAtWorldPoint(q,y),m.vsub(y,C);var H=g.dot(C),W=.2,A=1/(z.invMass+Y.invMass),L=-W*H*A;return L}},{"../collision/Ray":9,"../collision/RaycastResult":10,"../math/Quaternion":28,"../math/Vec3":30,"../objects/WheelInfo":36,"./Body":31}],33:[function(v,V,et){var p=v("./Body"),e=v("../shapes/Sphere"),s=v("../shapes/Box"),r=v("../math/Vec3"),l=v("../constraints/HingeConstraint");V.exports=i;function i(n){if(this.wheelBodies=[],this.coordinateSystem=typeof n.coordinateSystem>"u"?new r(1,2,3):n.coordinateSystem.clone(),this.chassisBody=n.chassisBody,!this.chassisBody){var a=new s(new r(5,2,.5));this.chassisBody=new p(1,a)}this.constraints=[],this.wheelAxes=[],this.wheelForces=[]}i.prototype.addWheel=function(n){n=n||{};var a=n.body;a||(a=new p(1,new e(1.2))),this.wheelBodies.push(a),this.wheelForces.push(0),new r;var c=typeof n.position<"u"?n.position.clone():new r,h=new r;this.chassisBody.pointToWorldFrame(c,h),a.position.set(h.x,h.y,h.z);var u=typeof n.axis<"u"?n.axis.clone():new r(0,1,0);this.wheelAxes.push(u);var d=new l(this.chassisBody,a,{pivotA:c,axisA:u,pivotB:r.ZERO,axisB:u,collideConnected:!1});return this.constraints.push(d),this.wheelBodies.length-1},i.prototype.setSteeringValue=function(n,a){var c=this.wheelAxes[a],h=Math.cos(n),u=Math.sin(n),d=c.x,x=c.y;this.constraints[a].axisA.set(h*d-u*x,u*d+h*x,0)},i.prototype.setMotorSpeed=function(n,a){var c=this.constraints[a];c.enableMotor(),c.motorTargetVelocity=n},i.prototype.disableMotor=function(n){var a=this.constraints[n];a.disableMotor()};var t=new r;i.prototype.setWheelForce=function(n,a){this.wheelForces[a]=n},i.prototype.applyWheelForce=function(n,a){var c=this.wheelAxes[a],h=this.wheelBodies[a],u=h.torque;c.scale(n,t),h.vectorToWorldFrame(t,t),u.vadd(t,u)},i.prototype.addToWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.add(c[h]);for(var h=0;h<a.length;h++)n.addConstraint(a[h]);n.addEventListener("preStep",this._update.bind(this))},i.prototype._update=function(){for(var n=this.wheelForces,a=0;a<n.length;a++)this.applyWheelForce(n[a],a)},i.prototype.removeFromWorld=function(n){for(var a=this.constraints,c=this.wheelBodies.concat([this.chassisBody]),h=0;h<c.length;h++)n.remove(c[h]);for(var h=0;h<a.length;h++)n.removeConstraint(a[h])};var o=new r;i.prototype.getWheelSpeed=function(n){var a=this.wheelAxes[n],c=this.wheelBodies[n],h=c.angularVelocity;return this.chassisBody.vectorToWorldFrame(a,o),h.dot(o)}},{"../constraints/HingeConstraint":15,"../math/Vec3":30,"../shapes/Box":37,"../shapes/Sphere":44,"./Body":31}],34:[function(v,V,et){V.exports=e,v("../shapes/Shape");var p=v("../math/Vec3");v("../math/Quaternion"),v("../shapes/Particle"),v("../objects/Body"),v("../material/Material");function e(){this.particles=[],this.density=1,this.smoothingRadius=1,this.speedOfSound=1,this.viscosity=.01,this.eps=1e-6,this.pressures=[],this.densities=[],this.neighbors=[]}e.prototype.add=function(a){this.particles.push(a),this.neighbors.length<this.particles.length&&this.neighbors.push([])},e.prototype.remove=function(a){var c=this.particles.indexOf(a);c!==-1&&(this.particles.splice(c,1),this.neighbors.length>this.particles.length&&this.neighbors.pop())};var s=new p;e.prototype.getNeighbors=function(a,c){for(var h=this.particles.length,u=a.id,d=this.smoothingRadius*this.smoothingRadius,x=s,f=0;f!==h;f++){var b=this.particles[f];b.position.vsub(a.position,x),u!==b.id&&x.norm2()<d&&c.push(b)}};var r=new p,l=new p,i=new p,t=new p,o=new p,n=new p;e.prototype.update=function(){for(var a=this.particles.length,c=r,h=this.speedOfSound,u=this.eps,d=0;d!==a;d++){var x=this.particles[d],f=this.neighbors[d];f.length=0,this.getNeighbors(x,f),f.push(this.particles[d]);for(var b=f.length,G=0,st=0;st!==b;st++){x.position.vsub(f[st].position,c);var T=c.norm(),k=this.w(T);G+=f[st].mass*k}this.densities[d]=G,this.pressures[d]=h*h*(this.densities[d]-this.density)}for(var M=l,B=i,N=t,F=o,j=n,d=0;d!==a;d++){var K=this.particles[d];M.set(0,0,0),B.set(0,0,0);for(var pt,z,f=this.neighbors[d],b=f.length,st=0;st!==b;st++){var E=f[st];K.position.vsub(E.position,F);var Y=F.norm();pt=-E.mass*(this.pressures[d]/(this.densities[d]*this.densities[d]+u)+this.pressures[st]/(this.densities[st]*this.densities[st]+u)),this.gradw(F,N),N.mult(pt,N),M.vadd(N,M),E.velocity.vsub(K.velocity,j),j.mult(1/(1e-4+this.densities[d]*this.densities[st])*this.viscosity*E.mass,j),z=this.nablaw(Y),j.mult(z,j),B.vadd(j,B)}B.mult(K.mass,B),M.mult(K.mass,M),K.force.vadd(B,K.force),K.force.vadd(M,K.force)}},e.prototype.w=function(a){var c=this.smoothingRadius;return 315/(64*Math.PI*Math.pow(c,9))*Math.pow(c*c-a*a,3)},e.prototype.gradw=function(a,c){var h=a.norm(),u=this.smoothingRadius;a.mult(945/(32*Math.PI*Math.pow(u,9))*Math.pow(u*u-h*h,2),c)},e.prototype.nablaw=function(a){var c=this.smoothingRadius,h=945/(32*Math.PI*Math.pow(c,9))*(c*c-a*a)*(7*a*a-3*c*c);return h}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Particle":41,"../shapes/Shape":43}],35:[function(v,V,et){var p=v("../math/Vec3");V.exports=e;function e(d,x,f){f=f||{},this.restLength=typeof f.restLength=="number"?f.restLength:1,this.stiffness=f.stiffness||100,this.damping=f.damping||1,this.bodyA=d,this.bodyB=x,this.localAnchorA=new p,this.localAnchorB=new p,f.localAnchorA&&this.localAnchorA.copy(f.localAnchorA),f.localAnchorB&&this.localAnchorB.copy(f.localAnchorB),f.worldAnchorA&&this.setWorldAnchorA(f.worldAnchorA),f.worldAnchorB&&this.setWorldAnchorB(f.worldAnchorB)}e.prototype.setWorldAnchorA=function(d){this.bodyA.pointToLocalFrame(d,this.localAnchorA)},e.prototype.setWorldAnchorB=function(d){this.bodyB.pointToLocalFrame(d,this.localAnchorB)},e.prototype.getWorldAnchorA=function(d){this.bodyA.pointToWorldFrame(this.localAnchorA,d)},e.prototype.getWorldAnchorB=function(d){this.bodyB.pointToWorldFrame(this.localAnchorB,d)};var s=new p,r=new p,l=new p,i=new p,t=new p,o=new p,n=new p,a=new p,c=new p,h=new p,u=new p;e.prototype.applyForce=function(){var d=this.stiffness,x=this.damping,f=this.restLength,b=this.bodyA,G=this.bodyB,st=s,T=r,k=l,M=i,B=u,N=t,F=o,j=n,K=a,pt=c,z=h;this.getWorldAnchorA(N),this.getWorldAnchorB(F),N.vsub(b.position,j),F.vsub(G.position,K),F.vsub(N,st);var E=st.norm();T.copy(st),T.normalize(),G.velocity.vsub(b.velocity,k),G.angularVelocity.cross(K,B),k.vadd(B,k),b.angularVelocity.cross(j,B),k.vsub(B,k),T.mult(-d*(E-f)-x*k.dot(T),M),b.force.vsub(M,b.force),G.force.vadd(M,G.force),j.cross(M,pt),K.cross(M,z),b.torque.vsub(pt,b.torque),G.torque.vadd(z,G.torque)}},{"../math/Vec3":30}],36:[function(v,V,et){var p=v("../math/Vec3"),e=v("../math/Transform"),s=v("../collision/RaycastResult"),r=v("../utils/Utils");V.exports=l;function l(o){o=r.defaults(o,{chassisConnectionPointLocal:new p,chassisConnectionPointWorld:new p,directionLocal:new p,directionWorld:new p,axleLocal:new p,axleWorld:new p,suspensionRestLength:1,suspensionMaxLength:2,radius:1,suspensionStiffness:100,dampingCompression:10,dampingRelaxation:10,frictionSlip:1e4,steering:0,rotation:0,deltaRotation:0,rollInfluence:.01,maxSuspensionForce:Number.MAX_VALUE,isFrontWheel:!0,clippedInvContactDotSuspension:1,suspensionRelativeVelocity:0,suspensionForce:0,skidInfo:0,suspensionLength:0,maxSuspensionTravel:1,useCustomSlidingRotationalSpeed:!1,customSlidingRotationalSpeed:-.1}),this.maxSuspensionTravel=o.maxSuspensionTravel,this.customSlidingRotationalSpeed=o.customSlidingRotationalSpeed,this.useCustomSlidingRotationalSpeed=o.useCustomSlidingRotationalSpeed,this.sliding=!1,this.chassisConnectionPointLocal=o.chassisConnectionPointLocal.clone(),this.chassisConnectionPointWorld=o.chassisConnectionPointWorld.clone(),this.directionLocal=o.directionLocal.clone(),this.directionWorld=o.directionWorld.clone(),this.axleLocal=o.axleLocal.clone(),this.axleWorld=o.axleWorld.clone(),this.suspensionRestLength=o.suspensionRestLength,this.suspensionMaxLength=o.suspensionMaxLength,this.radius=o.radius,this.suspensionStiffness=o.suspensionStiffness,this.dampingCompression=o.dampingCompression,this.dampingRelaxation=o.dampingRelaxation,this.frictionSlip=o.frictionSlip,this.steering=0,this.rotation=0,this.deltaRotation=0,this.rollInfluence=o.rollInfluence,this.maxSuspensionForce=o.maxSuspensionForce,this.engineForce=0,this.brake=0,this.isFrontWheel=o.isFrontWheel,this.clippedInvContactDotSuspension=1,this.suspensionRelativeVelocity=0,this.suspensionForce=0,this.skidInfo=0,this.suspensionLength=0,this.sideImpulse=0,this.forwardImpulse=0,this.raycastResult=new s,this.worldTransform=new e,this.isInContact=!1}var t=new p,i=new p,t=new p;l.prototype.updateWheel=function(o){var n=this.raycastResult;if(this.isInContact){var a=n.hitNormalWorld.dot(n.directionWorld);n.hitPointWorld.vsub(o.position,i),o.getVelocityAtWorldPoint(i,t);var c=n.hitNormalWorld.dot(t);if(a>=-.1)this.suspensionRelativeVelocity=0,this.clippedInvContactDotSuspension=1/.1;else{var h=-1/a;this.suspensionRelativeVelocity=c*h,this.clippedInvContactDotSuspension=h}}else n.suspensionLength=this.suspensionRestLength,this.suspensionRelativeVelocity=0,n.directionWorld.scale(-1,n.hitNormalWorld),this.clippedInvContactDotSuspension=1}},{"../collision/RaycastResult":10,"../math/Transform":29,"../math/Vec3":30,"../utils/Utils":53}],37:[function(v,V,et){V.exports=r;var p=v("./Shape"),e=v("../math/Vec3"),s=v("./ConvexPolyhedron");function r(t){p.call(this),this.type=p.types.BOX,this.halfExtents=t,this.convexPolyhedronRepresentation=null,this.updateConvexPolyhedronRepresentation(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r,r.prototype.updateConvexPolyhedronRepresentation=function(){var t=this.halfExtents.x,o=this.halfExtents.y,n=this.halfExtents.z,a=e,c=[new a(-t,-o,-n),new a(t,-o,-n),new a(t,o,-n),new a(-t,o,-n),new a(-t,-o,n),new a(t,-o,n),new a(t,o,n),new a(-t,o,n)],h=[[3,2,1,0],[4,5,6,7],[5,4,0,1],[2,3,7,6],[0,4,7,3],[1,2,6,5]];new a(0,0,1),new a(0,1,0),new a(1,0,0);var u=new s(c,h);this.convexPolyhedronRepresentation=u,u.material=this.material},r.prototype.calculateLocalInertia=function(t,o){return o=o||new e,r.calculateInertia(this.halfExtents,t,o),o},r.calculateInertia=function(t,o,n){var a=t;n.x=1/12*o*(2*a.y*2*a.y+2*a.z*2*a.z),n.y=1/12*o*(2*a.x*2*a.x+2*a.z*2*a.z),n.z=1/12*o*(2*a.y*2*a.y+2*a.x*2*a.x)},r.prototype.getSideNormals=function(t,o){var n=t,a=this.halfExtents;if(n[0].set(a.x,0,0),n[1].set(0,a.y,0),n[2].set(0,0,a.z),n[3].set(-a.x,0,0),n[4].set(0,-a.y,0),n[5].set(0,0,-a.z),o!==void 0)for(var c=0;c!==n.length;c++)o.vmult(n[c],n[c]);return n},r.prototype.volume=function(){return 8*this.halfExtents.x*this.halfExtents.y*this.halfExtents.z},r.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.halfExtents.norm()};var l=new e;new e,r.prototype.forEachWorldCorner=function(t,o,n){for(var a=this.halfExtents,c=[[a.x,a.y,a.z],[-a.x,a.y,a.z],[-a.x,-a.y,a.z],[-a.x,-a.y,-a.z],[a.x,-a.y,-a.z],[a.x,a.y,-a.z],[-a.x,a.y,-a.z],[a.x,-a.y,a.z]],h=0;h<c.length;h++)l.set(c[h][0],c[h][1],c[h][2]),o.vmult(l,l),t.vadd(l,l),n(l.x,l.y,l.z)};var i=[new e,new e,new e,new e,new e,new e,new e,new e];r.prototype.calculateWorldAABB=function(t,o,n,a){var c=this.halfExtents;i[0].set(c.x,c.y,c.z),i[1].set(-c.x,c.y,c.z),i[2].set(-c.x,-c.y,c.z),i[3].set(-c.x,-c.y,-c.z),i[4].set(c.x,-c.y,-c.z),i[5].set(c.x,c.y,-c.z),i[6].set(-c.x,c.y,-c.z),i[7].set(c.x,-c.y,c.z);var h=i[0];o.vmult(h,h),t.vadd(h,h),a.copy(h),n.copy(h);for(var u=1;u<8;u++){var h=i[u];o.vmult(h,h),t.vadd(h,h);var d=h.x,x=h.y,f=h.z;d>a.x&&(a.x=d),x>a.y&&(a.y=x),f>a.z&&(a.z=f),d<n.x&&(n.x=d),x<n.y&&(n.y=x),f<n.z&&(n.z=f)}}},{"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],38:[function(v,V,et){V.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform");function r(g,R,w){p.call(this),this.type=p.types.CONVEXPOLYHEDRON,this.vertices=g||[],this.worldVertices=[],this.worldVerticesNeedsUpdate=!0,this.faces=R||[],this.faceNormals=[],this.computeNormals(),this.worldFaceNormalsNeedsUpdate=!0,this.worldFaceNormals=[],this.uniqueEdges=[],this.uniqueAxes=w?w.slice():null,this.computeEdges(),this.updateBoundingSphereRadius()}r.prototype=new p,r.prototype.constructor=r;var l=new e;r.prototype.computeEdges=function(){var g=this.faces,R=this.vertices;R.length;var w=this.uniqueEdges;w.length=0;for(var m=l,y=0;y!==g.length;y++)for(var C=g[y],H=C.length,W=0;W!==H;W++){var A=(W+1)%H;R[C[W]].vsub(R[C[A]],m),m.normalize();for(var L=!1,X=0;X!==w.length;X++)if(w[X].almostEquals(m)||w[X].almostEquals(m)){L=!0;break}L||w.push(m.clone())}},r.prototype.computeNormals=function(){this.faceNormals.length=this.faces.length;for(var g=0;g<this.faces.length;g++){for(var R=0;R<this.faces[g].length;R++)if(!this.vertices[this.faces[g][R]])throw new Error("Vertex "+this.faces[g][R]+" not found!");var w=this.faceNormals[g]||new e;this.getFaceNormal(g,w),w.negate(w),this.faceNormals[g]=w;var m=this.vertices[this.faces[g][0]];if(w.dot(m)<0){console.error(".faceNormals["+g+"] = Vec3("+w.toString()+") looks like it points into the shape? The vertices follow. Make sure they are ordered CCW around the normal, using the right hand rule.");for(var R=0;R<this.faces[g].length;R++)console.warn(".vertices["+this.faces[g][R]+"] = Vec3("+this.vertices[this.faces[g][R]].toString()+")")}}};var i=new e,t=new e;r.computeNormal=function(g,R,w,m){R.vsub(g,t),w.vsub(R,i),i.cross(t,m),m.isZero()||m.normalize()},r.prototype.getFaceNormal=function(g,R){var w=this.faces[g],m=this.vertices[w[0]],y=this.vertices[w[1]],C=this.vertices[w[2]];return r.computeNormal(m,y,C,R)};var o=new e;r.prototype.clipAgainstHull=function(g,R,w,m,y,C,H,W,A){for(var L=o,X=-1,ut=-Number.MAX_VALUE,lt=0;lt<w.faces.length;lt++){L.copy(w.faceNormals[lt]),y.vmult(L,L);var at=L.dot(C);at>ut&&(ut=at,X=lt)}for(var O=[],Q=w.faces[X],bt=Q.length,ft=0;ft<bt;ft++){var Pt=w.vertices[Q[ft]],ct=new e;ct.copy(Pt),y.vmult(ct,ct),m.vadd(ct,ct),O.push(ct)}X>=0&&this.clipFaceAgainstHull(C,g,R,O,H,W,A)};var n=new e,a=new e,c=new e,h=new e,u=new e,d=new e;r.prototype.findSeparatingAxis=function(g,R,w,m,y,C,H,W){var A=n,L=a,X=c,ut=h,lt=u,at=d,O=Number.MAX_VALUE,Q=this;if(Q.uniqueAxes)for(var ft=0;ft!==Q.uniqueAxes.length;ft++){w.vmult(Q.uniqueAxes[ft],A);var ct=Q.testSepAxis(A,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(A))}else for(var bt=H?H.length:Q.faces.length,ft=0;ft<bt;ft++){var Pt=H?H[ft]:ft;A.copy(Q.faceNormals[Pt]),w.vmult(A,A);var ct=Q.testSepAxis(A,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(A))}if(g.uniqueAxes)for(var ft=0;ft!==g.uniqueAxes.length;ft++){y.vmult(g.uniqueAxes[ft],L);var ct=Q.testSepAxis(L,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(L))}else for(var Mt=W?W.length:g.faces.length,ft=0;ft<Mt;ft++){var Pt=W?W[ft]:ft;L.copy(g.faceNormals[Pt]),y.vmult(L,L);var ct=Q.testSepAxis(L,g,R,w,m,y);if(ct===!1)return!1;ct<O&&(O=ct,C.copy(L))}for(var zt=0;zt!==Q.uniqueEdges.length;zt++){w.vmult(Q.uniqueEdges[zt],ut);for(var Rt=0;Rt!==g.uniqueEdges.length;Rt++)if(y.vmult(g.uniqueEdges[Rt],lt),ut.cross(lt,at),!at.almostZero()){at.normalize();var Tt=Q.testSepAxis(at,g,R,w,m,y);if(Tt===!1)return!1;Tt<O&&(O=Tt,C.copy(at))}}return m.vsub(R,X),X.dot(C)>0&&C.negate(C),!0};var x=[],f=[];r.prototype.testSepAxis=function(g,R,w,m,y,C){var H=this;r.project(H,g,w,m,x),r.project(R,g,y,C,f);var W=x[0],A=x[1],L=f[0],X=f[1],ut=W-X,lt=L-A,at=ut<lt?ut:lt;return at};var b=new e,G=new e;r.prototype.calculateLocalInertia=function(g,R){this.computeLocalAABB(b,G);var w=G.x-b.x,m=G.y-b.y,y=G.z-b.z;R.x=1/12*g*(2*m*2*m+2*y*2*y),R.y=1/12*g*(2*w*2*w+2*y*2*y),R.z=1/12*g*(2*m*2*m+2*w*2*w)},r.prototype.getPlaneConstantOfFace=function(g){var R=this.faces[g],w=this.faceNormals[g],m=this.vertices[R[0]],y=-w.dot(m);return y};var st=new e,T=new e,k=new e,M=new e,B=new e,N=new e,F=new e,j=new e;r.prototype.clipFaceAgainstHull=function(g,R,w,m,y,C,H){for(var W=st,A=T,L=k,X=M,ut=B,lt=N,at=F,O=j,Q=this,bt=[],ft=m,Pt=bt,ct=-1,Mt=Number.MAX_VALUE,zt=0;zt<Q.faces.length;zt++){W.copy(Q.faceNormals[zt]),w.vmult(W,W);var Rt=W.dot(g);Rt<Mt&&(Mt=Rt,ct=zt)}if(!(ct<0)){var Tt=Q.faces[ct];Tt.connectedFaces=[];for(var Et=0;Et<Q.faces.length;Et++)for(var Ft=0;Ft<Q.faces[Et].length;Ft++)Tt.indexOf(Q.faces[Et][Ft])!==-1&&Et!==ct&&Tt.connectedFaces.indexOf(Et)===-1&&Tt.connectedFaces.push(Et);ft.length;for(var At=Tt.length,qt=0;qt<At;qt++){var Ut=Q.vertices[Tt[qt]],ne=Q.vertices[Tt[(qt+1)%At]];Ut.vsub(ne,A),L.copy(A),w.vmult(L,L),R.vadd(L,L),X.copy(this.faceNormals[ct]),w.vmult(X,X),R.vadd(X,X),L.cross(X,ut),ut.negate(ut),lt.copy(Ut),w.vmult(lt,lt),R.vadd(lt,lt),-lt.dot(ut);var Kt;{var ue=Tt.connectedFaces[qt];at.copy(this.faceNormals[ue]);var ae=this.getPlaneConstantOfFace(ue);O.copy(at),w.vmult(O,O);var Kt=ae-O.dot(R)}for(this.clipFaceAgainstPlane(ft,Pt,O,Kt);ft.length;)ft.shift();for(;Pt.length;)ft.push(Pt.shift())}at.copy(this.faceNormals[ct]);var ae=this.getPlaneConstantOfFace(ct);O.copy(at),w.vmult(O,O);for(var Kt=ae-O.dot(R),Et=0;Et<ft.length;Et++){var jt=O.dot(ft[Et])+Kt;if(jt<=y&&(console.log("clamped: depth="+jt+" to minDist="+(y+"")),jt=y),jt<=C){var ve=ft[Et];if(jt<=0){var pe={point:ve,normal:O,depth:jt};H.push(pe)}}}}},r.prototype.clipFaceAgainstPlane=function(g,R,w,m){var y,C,H=g.length;if(H<2)return R;var W=g[g.length-1],A=g[0];y=w.dot(W)+m;for(var L=0;L<H;L++){if(A=g[L],C=w.dot(A)+m,y<0)if(C<0){var X=new e;X.copy(A),R.push(X)}else{var X=new e;W.lerp(A,y/(y-C),X),R.push(X)}else if(C<0){var X=new e;W.lerp(A,y/(y-C),X),R.push(X),R.push(A)}W=A,y=C}return R},r.prototype.computeWorldVertices=function(g,R){for(var w=this.vertices.length;this.worldVertices.length<w;)this.worldVertices.push(new e);for(var m=this.vertices,y=this.worldVertices,C=0;C!==w;C++)R.vmult(m[C],y[C]),g.vadd(y[C],y[C]);this.worldVerticesNeedsUpdate=!1},new e,r.prototype.computeLocalAABB=function(g,R){var w=this.vertices.length,m=this.vertices;g.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE),R.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE);for(var y=0;y<w;y++){var C=m[y];C.x<g.x?g.x=C.x:C.x>R.x&&(R.x=C.x),C.y<g.y?g.y=C.y:C.y>R.y&&(R.y=C.y),C.z<g.z?g.z=C.z:C.z>R.z&&(R.z=C.z)}},r.prototype.computeWorldFaceNormals=function(g){for(var R=this.faceNormals.length;this.worldFaceNormals.length<R;)this.worldFaceNormals.push(new e);for(var w=this.faceNormals,m=this.worldFaceNormals,y=0;y!==R;y++)g.vmult(w[y],m[y]);this.worldFaceNormalsNeedsUpdate=!1},r.prototype.updateBoundingSphereRadius=function(){for(var g=0,R=this.vertices,w=0,m=R.length;w!==m;w++){var y=R[w].norm2();y>g&&(g=y)}this.boundingSphereRadius=Math.sqrt(g)};var K=new e;r.prototype.calculateWorldAABB=function(g,R,w,m){for(var y=this.vertices.length,C=this.vertices,H,W,A,L,X,ut,lt=0;lt<y;lt++){K.copy(C[lt]),R.vmult(K,K),g.vadd(K,K);var at=K;at.x<H||H===void 0?H=at.x:(at.x>L||L===void 0)&&(L=at.x),at.y<W||W===void 0?W=at.y:(at.y>X||X===void 0)&&(X=at.y),at.z<A||A===void 0?A=at.z:(at.z>ut||ut===void 0)&&(ut=at.z)}w.set(H,W,A),m.set(L,X,ut)},r.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},r.prototype.getAveragePointLocal=function(g){g=g||new e;for(var R=this.vertices.length,w=this.vertices,m=0;m<R;m++)g.vadd(w[m],g);return g.mult(1/R,g),g},r.prototype.transformAllPoints=function(g,R){var w=this.vertices.length,m=this.vertices;if(R){for(var y=0;y<w;y++){var C=m[y];R.vmult(C,C)}for(var y=0;y<this.faceNormals.length;y++){var C=this.faceNormals[y];R.vmult(C,C)}}if(g)for(var y=0;y<w;y++){var C=m[y];C.vadd(g,C)}};var pt=new e,z=new e,E=new e;r.prototype.pointIsInside=function(g){var R=this.vertices.length,w=this.vertices,m=this.faces,y=this.faceNormals,C=null,H=this.faces.length,W=pt;this.getAveragePointLocal(W);for(var A=0;A<H;A++){this.faces[A].length;var R=y[A],L=w[m[A][0]],X=z;g.vsub(L,X);var ut=R.dot(X),lt=E;W.vsub(L,lt);var at=R.dot(lt);if(ut<0&&at>0||ut>0&&at<0)return!1}return C?1:-1},new e;var Y=new e,q=new e;r.project=function(g,R,w,m,y){var C=g.vertices.length,H=Y,W=0,A=0,L=q,X=g.vertices;L.setZero(),s.vectorToLocalFrame(w,m,R,H),s.pointToLocalFrame(w,m,L,L);var ut=L.dot(H);A=W=X[0].dot(H);for(var lt=1;lt<C;lt++){var at=X[lt].dot(H);at>W&&(W=at),at<A&&(A=at)}if(A-=ut,W-=ut,A>W){var O=A;A=W,W=O}y[0]=W,y[1]=A}},{"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"./Shape":43}],39:[function(v,V,et){V.exports=r;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("./ConvexPolyhedron");function r(l,i,t,o){var n=o,a=[],c=[],h=[],u=[],d=[],x=Math.cos,f=Math.sin;a.push(new e(i*x(0),i*f(0),-t*.5)),u.push(0),a.push(new e(l*x(0),l*f(0),t*.5)),d.push(1);for(var b=0;b<n;b++){var G=2*Math.PI/n*(b+1),st=2*Math.PI/n*(b+.5);b<n-1?(a.push(new e(i*x(G),i*f(G),-t*.5)),u.push(2*b+2),a.push(new e(l*x(G),l*f(G),t*.5)),d.push(2*b+3),h.push([2*b+2,2*b+3,2*b+1,2*b])):h.push([0,1,2*b+1,2*b]),(n%2===1||b<n/2)&&c.push(new e(x(st),f(st),0))}h.push(d),c.push(new e(0,0,1));for(var T=[],b=0;b<u.length;b++)T.push(u[u.length-b-1]);h.push(T),this.type=p.types.CONVEXPOLYHEDRON,s.call(this,a,h,c)}r.prototype=new s},{"../math/Quaternion":28,"../math/Vec3":30,"./ConvexPolyhedron":38,"./Shape":43}],40:[function(v,V,et){var p=v("./Shape"),e=v("./ConvexPolyhedron"),s=v("../math/Vec3"),r=v("../utils/Utils");V.exports=l;function l(i,t){t=r.defaults(t,{maxValue:null,minValue:null,elementSize:1}),this.data=i,this.maxValue=t.maxValue,this.minValue=t.minValue,this.elementSize=t.elementSize,t.minValue===null&&this.updateMinValue(),t.maxValue===null&&this.updateMaxValue(),this.cacheEnabled=!0,p.call(this),this.pillarConvex=new e,this.pillarOffset=new s,this.type=p.types.HEIGHTFIELD,this.updateBoundingSphereRadius(),this._cachedPillars={}}l.prototype=new p,l.prototype.update=function(){this._cachedPillars={}},l.prototype.updateMinValue=function(){for(var i=this.data,t=i[0][0],o=0;o!==i.length;o++)for(var n=0;n!==i[o].length;n++){var a=i[o][n];a<t&&(t=a)}this.minValue=t},l.prototype.updateMaxValue=function(){for(var i=this.data,t=i[0][0],o=0;o!==i.length;o++)for(var n=0;n!==i[o].length;n++){var a=i[o][n];a>t&&(t=a)}this.maxValue=t},l.prototype.setHeightValueAtIndex=function(i,t,o){var n=this.data;n[i][t]=o,this.clearCachedConvexTrianglePillar(i,t,!1),i>0&&(this.clearCachedConvexTrianglePillar(i-1,t,!0),this.clearCachedConvexTrianglePillar(i-1,t,!1)),t>0&&(this.clearCachedConvexTrianglePillar(i,t-1,!0),this.clearCachedConvexTrianglePillar(i,t-1,!1)),t>0&&i>0&&this.clearCachedConvexTrianglePillar(i-1,t-1,!0)},l.prototype.getRectMinMax=function(i,t,o,n,a){a=a||[];for(var c=this.data,h=this.minValue,u=i;u<=o;u++)for(var d=t;d<=n;d++){var x=c[u][d];x>h&&(h=x)}a[0]=this.minValue,a[1]=h},l.prototype.getIndexOfPosition=function(i,t,o,n){var a=this.elementSize,c=this.data,h=Math.floor(i/a),u=Math.floor(t/a);return o[0]=h,o[1]=u,n&&(h<0&&(h=0),u<0&&(u=0),h>=c.length-1&&(h=c.length-1),u>=c[0].length-1&&(u=c[0].length-1)),!(h<0||u<0||h>=c.length-1||u>=c[0].length-1)},l.prototype.getHeightAt=function(i,t,o){var n=[];this.getIndexOfPosition(i,t,n,o);var a=[];return this.getRectMinMax(n[0],n[1]+1,n[0],n[1]+1,a),(a[0]+a[1])/2},l.prototype.getCacheConvexTrianglePillarKey=function(i,t,o){return i+"_"+t+"_"+(o?1:0)},l.prototype.getCachedConvexTrianglePillar=function(i,t,o){return this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]},l.prototype.setCachedConvexTrianglePillar=function(i,t,o,n,a){this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]={convex:n,offset:a}},l.prototype.clearCachedConvexTrianglePillar=function(i,t,o){delete this._cachedPillars[this.getCacheConvexTrianglePillarKey(i,t,o)]},l.prototype.getConvexTrianglePillar=function(i,t,o){var n=this.pillarConvex,a=this.pillarOffset;if(this.cacheEnabled){var c=this.getCachedConvexTrianglePillar(i,t,o);if(c){this.pillarConvex=c.convex,this.pillarOffset=c.offset;return}n=new e,a=new s,this.pillarConvex=n,this.pillarOffset=a}var c=this.data,h=this.elementSize,u=n.faces;n.vertices.length=6;for(var d=0;d<6;d++)n.vertices[d]||(n.vertices[d]=new s);u.length=5;for(var d=0;d<5;d++)u[d]||(u[d]=[]);var x=n.vertices,f=(Math.min(c[i][t],c[i+1][t],c[i][t+1],c[i+1][t+1])-this.minValue)/2+this.minValue;o?(a.set((i+.75)*h,(t+.75)*h,f),x[0].set(.25*h,.25*h,c[i+1][t+1]-f),x[1].set(-.75*h,.25*h,c[i][t+1]-f),x[2].set(.25*h,-.75*h,c[i+1][t]-f),x[3].set(.25*h,.25*h,-f-1),x[4].set(-.75*h,.25*h,-f-1),x[5].set(.25*h,-.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=2,u[2][1]=5,u[2][2]=3,u[2][3]=0,u[3][0]=3,u[3][1]=4,u[3][2]=1,u[3][3]=0,u[4][0]=1,u[4][1]=4,u[4][2]=5,u[4][3]=2):(a.set((i+.25)*h,(t+.25)*h,f),x[0].set(-.25*h,-.25*h,c[i][t]-f),x[1].set(.75*h,-.25*h,c[i+1][t]-f),x[2].set(-.25*h,.75*h,c[i][t+1]-f),x[3].set(-.25*h,-.25*h,-f-1),x[4].set(.75*h,-.25*h,-f-1),x[5].set(-.25*h,.75*h,-f-1),u[0][0]=0,u[0][1]=1,u[0][2]=2,u[1][0]=5,u[1][1]=4,u[1][2]=3,u[2][0]=0,u[2][1]=2,u[2][2]=5,u[2][3]=3,u[3][0]=1,u[3][1]=0,u[3][2]=3,u[3][3]=4,u[4][0]=4,u[4][1]=5,u[4][2]=2,u[4][3]=1),n.computeNormals(),n.computeEdges(),n.updateBoundingSphereRadius(),this.setCachedConvexTrianglePillar(i,t,o,n,a)},l.prototype.calculateLocalInertia=function(i,t){return t=t||new s,t.set(0,0,0),t},l.prototype.volume=function(){return Number.MAX_VALUE},l.prototype.calculateWorldAABB=function(i,t,o,n){o.set(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),n.set(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)},l.prototype.updateBoundingSphereRadius=function(){var i=this.data,t=this.elementSize;this.boundingSphereRadius=new s(i.length*t,i[0].length*t,Math.max(Math.abs(this.maxValue),Math.abs(this.minValue))).norm()}},{"../math/Vec3":30,"../utils/Utils":53,"./ConvexPolyhedron":38,"./Shape":43}],41:[function(v,V,et){V.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PARTICLE}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){return l=l||new e,l.set(0,0,0),l},s.prototype.volume=function(){return 0},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=0},s.prototype.calculateWorldAABB=function(r,l,i,t){i.copy(r),t.copy(r)}},{"../math/Vec3":30,"./Shape":43}],42:[function(v,V,et){V.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(){p.call(this),this.type=p.types.PLANE,this.worldNormal=new e,this.worldNormalNeedsUpdate=!0,this.boundingSphereRadius=Number.MAX_VALUE}s.prototype=new p,s.prototype.constructor=s,s.prototype.computeWorldNormal=function(l){var i=this.worldNormal;i.set(0,0,1),l.vmult(i,i),this.worldNormalNeedsUpdate=!1},s.prototype.calculateLocalInertia=function(l,i){return i=i||new e,i},s.prototype.volume=function(){return Number.MAX_VALUE};var r=new e;s.prototype.calculateWorldAABB=function(l,i,t,o){r.set(0,0,1),i.vmult(r,r);var n=Number.MAX_VALUE;t.set(-n,-n,-n),o.set(n,n,n),r.x===1&&(o.x=l.x),r.y===1&&(o.y=l.y),r.z===1&&(o.z=l.z),r.x===-1&&(t.x=l.x),r.y===-1&&(t.y=l.y),r.z===-1&&(t.z=l.z)},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=Number.MAX_VALUE}},{"../math/Vec3":30,"./Shape":43}],43:[function(v,V,et){V.exports=p;var p=v("./Shape");v("../math/Vec3"),v("../math/Quaternion"),v("../material/Material");function p(){this.id=p.idCounter++,this.type=0,this.boundingSphereRadius=0,this.collisionResponse=!0,this.material=null}p.prototype.constructor=p,p.prototype.updateBoundingSphereRadius=function(){throw"computeBoundingSphereRadius() not implemented for shape type "+this.type},p.prototype.volume=function(){throw"volume() not implemented for shape type "+this.type},p.prototype.calculateLocalInertia=function(e,s){throw"calculateLocalInertia() not implemented for shape type "+this.type},p.idCounter=0,p.types={SPHERE:1,PLANE:2,BOX:4,COMPOUND:8,CONVEXPOLYHEDRON:16,HEIGHTFIELD:32,PARTICLE:64,CYLINDER:128,TRIMESH:256}},{"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"./Shape":43}],44:[function(v,V,et){V.exports=s;var p=v("./Shape"),e=v("../math/Vec3");function s(r){if(p.call(this),this.radius=r!==void 0?Number(r):1,this.type=p.types.SPHERE,this.radius<0)throw new Error("The sphere radius cannot be negative.");this.updateBoundingSphereRadius()}s.prototype=new p,s.prototype.constructor=s,s.prototype.calculateLocalInertia=function(r,l){l=l||new e;var i=2*r*this.radius*this.radius/5;return l.x=i,l.y=i,l.z=i,l},s.prototype.volume=function(){return 4*Math.PI*this.radius/3},s.prototype.updateBoundingSphereRadius=function(){this.boundingSphereRadius=this.radius},s.prototype.calculateWorldAABB=function(r,l,i,t){for(var o=this.radius,n=["x","y","z"],a=0;a<n.length;a++){var c=n[a];i[c]=r[c]-o,t[c]=r[c]+o}}},{"../math/Vec3":30,"./Shape":43}],45:[function(v,V,et){V.exports=i;var p=v("./Shape"),e=v("../math/Vec3");v("../math/Quaternion");var s=v("../math/Transform"),r=v("../collision/AABB"),l=v("../utils/Octree");function i(T,k){p.call(this),this.type=p.types.TRIMESH,this.vertices=new Float32Array(T),this.indices=new Int16Array(k),this.normals=new Float32Array(k.length),this.aabb=new r,this.edges=null,this.scale=new e(1,1,1),this.tree=new l,this.updateEdges(),this.updateNormals(),this.updateAABB(),this.updateBoundingSphereRadius(),this.updateTree()}i.prototype=new p,i.prototype.constructor=i;var t=new e;i.prototype.updateTree=function(){var T=this.tree;T.reset(),T.aabb.copy(this.aabb);var k=this.scale;T.aabb.lowerBound.x*=1/k.x,T.aabb.lowerBound.y*=1/k.y,T.aabb.lowerBound.z*=1/k.z,T.aabb.upperBound.x*=1/k.x,T.aabb.upperBound.y*=1/k.y,T.aabb.upperBound.z*=1/k.z;for(var M=new r,B=new e,N=new e,F=new e,j=[B,N,F],K=0;K<this.indices.length/3;K++){var pt=K*3;this._getUnscaledVertex(this.indices[pt],B),this._getUnscaledVertex(this.indices[pt+1],N),this._getUnscaledVertex(this.indices[pt+2],F),M.setFromPoints(j),T.insert(M,K)}T.removeEmptyNodes()};var o=new r;i.prototype.getTrianglesInAABB=function(T,k){o.copy(T);var M=this.scale,B=M.x,N=M.y,F=M.z,j=o.lowerBound,K=o.upperBound;return j.x/=B,j.y/=N,j.z/=F,K.x/=B,K.y/=N,K.z/=F,this.tree.aabbQuery(o,k)},i.prototype.setScale=function(T){var k=this.scale.x===this.scale.y===this.scale.z,M=T.x===T.y===T.z;k&&M||this.updateNormals(),this.scale.copy(T),this.updateAABB(),this.updateBoundingSphereRadius()},i.prototype.updateNormals=function(){for(var T=t,k=this.normals,M=0;M<this.indices.length/3;M++){var B=M*3,N=this.indices[B],F=this.indices[B+1],j=this.indices[B+2];this.getVertex(N,u),this.getVertex(F,d),this.getVertex(j,x),i.computeNormal(d,u,x,T),k[B]=T.x,k[B+1]=T.y,k[B+2]=T.z}},i.prototype.updateEdges=function(){for(var T={},k=function(pt,z){var E=N<F?N+"_"+F:F+"_"+N;T[E]=!0},M=0;M<this.indices.length/3;M++){var B=M*3,N=this.indices[B],F=this.indices[B+1];this.indices[B+2],k(),k(),k()}var j=Object.keys(T);this.edges=new Int16Array(j.length*2);for(var M=0;M<j.length;M++){var K=j[M].split("_");this.edges[2*M]=parseInt(K[0],10),this.edges[2*M+1]=parseInt(K[1],10)}},i.prototype.getEdgeVertex=function(T,k,M){var B=this.edges[T*2+(k?1:0)];this.getVertex(B,M)};var n=new e,a=new e;i.prototype.getEdgeVector=function(T,k){var M=n,B=a;this.getEdgeVertex(T,0,M),this.getEdgeVertex(T,1,B),B.vsub(M,k)};var c=new e,h=new e;i.computeNormal=function(T,k,M,B){k.vsub(T,h),M.vsub(k,c),c.cross(h,B),B.isZero()||B.normalize()};var u=new e,d=new e,x=new e;i.prototype.getVertex=function(T,k){var M=this.scale;return this._getUnscaledVertex(T,k),k.x*=M.x,k.y*=M.y,k.z*=M.z,k},i.prototype._getUnscaledVertex=function(T,k){var M=T*3,B=this.vertices;return k.set(B[M],B[M+1],B[M+2])},i.prototype.getWorldVertex=function(T,k,M,B){return this.getVertex(T,B),s.pointToWorldFrame(k,M,B,B),B},i.prototype.getTriangleVertices=function(T,k,M,B){var N=T*3;this.getVertex(this.indices[N],k),this.getVertex(this.indices[N+1],M),this.getVertex(this.indices[N+2],B)},i.prototype.getNormal=function(T,k){var M=T*3;return k.set(this.normals[M],this.normals[M+1],this.normals[M+2])};var f=new r;i.prototype.calculateLocalInertia=function(T,k){this.computeLocalAABB(f);var M=f.upperBound.x-f.lowerBound.x,B=f.upperBound.y-f.lowerBound.y,N=f.upperBound.z-f.lowerBound.z;return k.set(1/12*T*(2*B*2*B+2*N*2*N),1/12*T*(2*M*2*M+2*N*2*N),1/12*T*(2*B*2*B+2*M*2*M))};var b=new e;i.prototype.computeLocalAABB=function(T){var k=T.lowerBound,M=T.upperBound,B=this.vertices.length;this.vertices;var N=b;this.getVertex(0,N),k.copy(N),M.copy(N);for(var F=0;F!==B;F++)this.getVertex(F,N),N.x<k.x?k.x=N.x:N.x>M.x&&(M.x=N.x),N.y<k.y?k.y=N.y:N.y>M.y&&(M.y=N.y),N.z<k.z?k.z=N.z:N.z>M.z&&(M.z=N.z)},i.prototype.updateAABB=function(){this.computeLocalAABB(this.aabb)},i.prototype.updateBoundingSphereRadius=function(){for(var T=0,k=this.vertices,M=new e,B=0,N=k.length/3;B!==N;B++){this.getVertex(B,M);var F=M.norm2();F>T&&(T=F)}this.boundingSphereRadius=Math.sqrt(T)},new e;var G=new s,st=new r;i.prototype.calculateWorldAABB=function(T,k,M,B){var N=G,F=st;N.position=T,N.quaternion=k,this.aabb.toWorldFrame(N,F),M.copy(F.lowerBound),B.copy(F.upperBound)},i.prototype.volume=function(){return 4*Math.PI*this.boundingSphereRadius/3},i.createTorus=function(T,k,M,B,N){T=T||1,k=k||.5,M=M||8,B=B||6,N=N||Math.PI*2;for(var F=[],j=[],K=0;K<=M;K++)for(var pt=0;pt<=B;pt++){var z=pt/B*N,E=K/M*Math.PI*2,Y=(T+k*Math.cos(E))*Math.cos(z),q=(T+k*Math.cos(E))*Math.sin(z),g=k*Math.sin(E);F.push(Y,q,g)}for(var K=1;K<=M;K++)for(var pt=1;pt<=B;pt++){var R=(B+1)*K+pt-1,w=(B+1)*(K-1)+pt-1,m=(B+1)*(K-1)+pt,y=(B+1)*K+pt;j.push(R,w,y),j.push(w,m,y)}return new i(F,j)}},{"../collision/AABB":3,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../utils/Octree":50,"./Shape":43}],46:[function(v,V,et){V.exports=e,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver");function e(){p.call(this),this.iterations=10,this.tolerance=1e-7}e.prototype=new p;var s=[],r=[],l=[];e.prototype.solve=function(i,t){var o=0,n=this.iterations,a=this.tolerance*this.tolerance,c=this.equations,h=c.length,u=t.bodies,d=u.length,x=i,f,b,G,st,T,k;if(h!==0)for(var M=0;M!==d;M++)u[M].updateSolveMassProperties();var B=r,N=l,F=s;B.length=h,N.length=h,F.length=h;for(var M=0;M!==h;M++){var j=c[M];F[M]=0,N[M]=j.computeB(x),B[M]=1/j.computeC()}if(h!==0){for(var M=0;M!==d;M++){var K=u[M],pt=K.vlambda,z=K.wlambda;pt.set(0,0,0),z&&z.set(0,0,0)}for(o=0;o!==n;o++){st=0;for(var E=0;E!==h;E++){var j=c[E];f=N[E],b=B[E],k=F[E],T=j.computeGWlambda(),G=b*(f-T-j.eps*k),k+G<j.minForce?G=j.minForce-k:k+G>j.maxForce&&(G=j.maxForce-k),F[E]+=G,st+=G>0?G:-G,j.addToWlambda(G)}if(st*st<a)break}for(var M=0;M!==d;M++){var K=u[M],Y=K.velocity,q=K.angularVelocity;Y.vadd(K.vlambda,Y),q&&q.vadd(K.wlambda,q)}}return o}},{"../math/Quaternion":28,"../math/Vec3":30,"./Solver":47}],47:[function(v,V,et){V.exports=p;function p(){this.equations=[]}p.prototype.solve=function(e,s){return 0},p.prototype.addEquation=function(e){e.enabled&&this.equations.push(e)},p.prototype.removeEquation=function(e){var s=this.equations,r=s.indexOf(e);r!==-1&&s.splice(r,1)},p.prototype.removeAllEquations=function(){this.equations.length=0}},{}],48:[function(v,V,et){V.exports=s,v("../math/Vec3"),v("../math/Quaternion");var p=v("./Solver"),e=v("../objects/Body");function s(u){for(p.call(this),this.iterations=10,this.tolerance=1e-7,this.subsolver=u,this.nodes=[],this.nodePool=[];this.nodePool.length<128;)this.nodePool.push(this.createNode())}s.prototype=new p;var r=[],l=[],i={bodies:[]},t=e.STATIC;function o(u){for(var d=u.length,x=0;x!==d;x++){var f=u[x];if(!f.visited&&!(f.body.type&t))return f}return!1}var n=[];function a(u,d,x,f){for(n.push(u),u.visited=!0,d(u,x,f);n.length;)for(var b=n.pop(),G;G=o(b.children);)G.visited=!0,d(G,x,f),n.push(G)}function c(u,d,x){d.push(u.body);for(var f=u.eqs.length,b=0;b!==f;b++){var G=u.eqs[b];x.indexOf(G)===-1&&x.push(G)}}s.prototype.createNode=function(){return{body:null,children:[],eqs:[],visited:!1}},s.prototype.solve=function(u,d){for(var x=r,f=this.nodePool,b=d.bodies,G=this.equations,st=G.length,T=b.length,k=this.subsolver;f.length<T;)f.push(this.createNode());x.length=T;for(var M=0;M<T;M++)x[M]=f[M];for(var M=0;M!==T;M++){var B=x[M];B.body=b[M],B.children.length=0,B.eqs.length=0,B.visited=!1}for(var N=0;N!==st;N++){var F=G[N],M=b.indexOf(F.bi),j=b.indexOf(F.bj),K=x[M],pt=x[j];K.children.push(pt),K.eqs.push(F),pt.children.push(K),pt.eqs.push(F)}var z,E=0,Y=l;k.tolerance=this.tolerance,k.iterations=this.iterations;for(var q=i;z=o(x);){Y.length=0,q.bodies.length=0,a(z,c,q.bodies,Y);var g=Y.length;Y=Y.sort(h);for(var M=0;M!==g;M++)k.addEquation(Y[M]);k.solve(u,q),k.removeAllEquations(),E++}return E};function h(u,d){return d.id-u.id}},{"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"./Solver":47}],49:[function(v,V,et){var p=function(){};V.exports=p,p.prototype={constructor:p,addEventListener:function(e,s){this._listeners===void 0&&(this._listeners={});var r=this._listeners;return r[e]===void 0&&(r[e]=[]),r[e].indexOf(s)===-1&&r[e].push(s),this},hasEventListener:function(e,s){if(this._listeners===void 0)return!1;var r=this._listeners;return r[e]!==void 0&&r[e].indexOf(s)!==-1},removeEventListener:function(e,s){if(this._listeners===void 0)return this;var r=this._listeners;if(r[e]===void 0)return this;var l=r[e].indexOf(s);return l!==-1&&r[e].splice(l,1),this},dispatchEvent:function(e){if(this._listeners===void 0)return this;var s=this._listeners,r=s[e.type];if(r!==void 0){e.target=this;for(var l=0,i=r.length;l<i;l++)r[l].call(this,e)}return this}}},{}],50:[function(v,V,et){var p=v("../collision/AABB"),e=v("../math/Vec3");V.exports=r;function s(t){t=t||{},this.root=t.root||null,this.aabb=t.aabb?t.aabb.clone():new p,this.data=[],this.children=[]}function r(t,o){o=o||{},o.root=null,o.aabb=t,s.call(this,o),this.maxDepth=typeof o.maxDepth<"u"?o.maxDepth:8}r.prototype=new s,s.prototype.reset=function(t,o){this.children.length=this.data.length=0},s.prototype.insert=function(t,o,n){var a=this.data;if(n=n||0,!this.aabb.contains(t))return!1;var c=this.children;if(n<(this.maxDepth||this.root.maxDepth)){var h=!1;c.length||(this.subdivide(),h=!0);for(var u=0;u!==8;u++)if(c[u].insert(t,o,n+1))return!0;h&&(c.length=0)}return a.push(o),!0};var l=new e;s.prototype.subdivide=function(){var t=this.aabb,o=t.lowerBound,n=t.upperBound,a=this.children;a.push(new s({aabb:new p({lowerBound:new e(0,0,0)})}),new s({aabb:new p({lowerBound:new e(1,0,0)})}),new s({aabb:new p({lowerBound:new e(1,1,0)})}),new s({aabb:new p({lowerBound:new e(1,1,1)})}),new s({aabb:new p({lowerBound:new e(0,1,1)})}),new s({aabb:new p({lowerBound:new e(0,0,1)})}),new s({aabb:new p({lowerBound:new e(1,0,1)})}),new s({aabb:new p({lowerBound:new e(0,1,0)})})),n.vsub(o,l),l.scale(.5,l);for(var c=this.root||this,h=0;h!==8;h++){var u=a[h];u.root=c;var d=u.aabb.lowerBound;d.x*=l.x,d.y*=l.y,d.z*=l.z,d.vadd(o,d),d.vadd(l,u.aabb.upperBound)}},s.prototype.aabbQuery=function(t,o){this.data,this.children;for(var n=[this];n.length;){var a=n.pop();a.aabb.overlaps(t)&&Array.prototype.push.apply(o,a.data),Array.prototype.push.apply(n,a.children)}return o};var i=new p;s.prototype.rayQuery=function(t,o,n){return t.getAABB(i),i.toLocalFrame(o,i),this.aabbQuery(i,n),n},s.prototype.removeEmptyNodes=function(){for(var t=[this];t.length;){for(var o=t.pop(),n=o.children.length-1;n>=0;n--)o.children[n].data.length||o.children.splice(n,1);Array.prototype.push.apply(t,o.children)}}},{"../collision/AABB":3,"../math/Vec3":30}],51:[function(v,V,et){V.exports=p;function p(){this.objects=[],this.type=Object}p.prototype.release=function(){for(var e=arguments.length,s=0;s!==e;s++)this.objects.push(arguments[s])},p.prototype.get=function(){return this.objects.length===0?this.constructObject():this.objects.pop()},p.prototype.constructObject=function(){throw new Error("constructObject() not implemented in this Pool subclass yet!")}},{}],52:[function(v,V,et){V.exports=p;function p(){this.data={keys:[]}}p.prototype.get=function(e,s){if(e>s){var r=s;s=e,e=r}return this.data[e+"-"+s]},p.prototype.set=function(e,s,r){if(e>s){var l=s;s=e,e=l}var i=e+"-"+s;this.get(e,s)||this.data.keys.push(i),this.data[i]=r},p.prototype.reset=function(){for(var e=this.data,s=e.keys;s.length>0;){var r=s.pop();delete e[r]}}},{}],53:[function(v,V,et){function p(){}V.exports=p,p.defaults=function(e,s){e=e||{};for(var r in s)r in e||(e[r]=s[r]);return e}},{}],54:[function(v,V,et){V.exports=s;var p=v("../math/Vec3"),e=v("./Pool");function s(){e.call(this),this.type=p}s.prototype=new e,s.prototype.constructObject=function(){return new p}},{"../math/Vec3":30,"./Pool":51}],55:[function(v,V,et){V.exports=a;var p=v("../collision/AABB"),e=v("../shapes/Shape"),s=v("../collision/Ray"),r=v("../math/Vec3"),l=v("../math/Transform");v("../shapes/ConvexPolyhedron");var i=v("../math/Quaternion");v("../solver/Solver");var t=v("../utils/Vec3Pool"),o=v("../equations/ContactEquation"),n=v("../equations/FrictionEquation");function a(P){this.contactPointPool=[],this.frictionEquationPool=[],this.result=[],this.frictionResult=[],this.v3pool=new t,this.world=P,this.currentContactMaterial=null,this.enableFrictionReduction=!1}a.prototype.createContactEquation=function(P,I,D,U,yt,nt){var J;this.contactPointPool.length?(J=this.contactPointPool.pop(),J.bi=P,J.bj=I):J=new o(P,I),J.enabled=P.collisionResponse&&I.collisionResponse&&D.collisionResponse&&U.collisionResponse;var ot=this.currentContactMaterial;J.restitution=ot.restitution,J.setSpookParams(ot.contactEquationStiffness,ot.contactEquationRelaxation,this.world.dt);var S=D.material||P.material,$=U.material||I.material;return S&&$&&S.restitution>=0&&$.restitution>=0&&(J.restitution=S.restitution*$.restitution),J.si=yt||D,J.sj=nt||U,J},a.prototype.createFrictionEquationsFromContact=function(P,I){var D=P.bi,U=P.bj,yt=P.si,nt=P.sj,J=this.world,ot=this.currentContactMaterial,S=ot.friction,$=yt.material||D.material,rt=nt.material||U.material;if($&&rt&&$.friction>=0&&rt.friction>=0&&(S=$.friction*rt.friction),S>0){var ht=S*J.gravity.length(),tt=D.invMass+U.invMass;tt>0&&(tt=1/tt);var Z=this.frictionEquationPool,it=Z.length?Z.pop():new n(D,U,ht*tt),vt=Z.length?Z.pop():new n(D,U,ht*tt);return it.bi=vt.bi=D,it.bj=vt.bj=U,it.minForce=vt.minForce=-ht*tt,it.maxForce=vt.maxForce=ht*tt,it.ri.copy(P.ri),it.rj.copy(P.rj),vt.ri.copy(P.ri),vt.rj.copy(P.rj),P.ni.tangents(it.t,vt.t),it.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),vt.setSpookParams(ot.frictionEquationStiffness,ot.frictionEquationRelaxation,J.dt),it.enabled=vt.enabled=P.enabled,I.push(it,vt),!0}return!1};var c=new r,h=new r,u=new r;a.prototype.createFrictionFromAverage=function(P){var I=this.result[this.result.length-1];if(!(!this.createFrictionEquationsFromContact(I,this.frictionResult)||P===1)){var D=this.frictionResult[this.frictionResult.length-2],U=this.frictionResult[this.frictionResult.length-1];c.setZero(),h.setZero(),u.setZero();var yt=I.bi;I.bj;for(var nt=0;nt!==P;nt++)I=this.result[this.result.length-1-nt],I.bodyA!==yt?(c.vadd(I.ni,c),h.vadd(I.ri,h),u.vadd(I.rj,u)):(c.vsub(I.ni,c),h.vadd(I.rj,h),u.vadd(I.ri,u));var J=1/P;h.scale(J,D.ri),u.scale(J,D.rj),U.ri.copy(D.ri),U.rj.copy(D.rj),c.normalize(),c.tangents(D.t,U.t)}};var d=new r,x=new r,f=new i,b=new i;a.prototype.getContacts=function(P,I,D,U,yt,nt,J){this.contactPointPool=yt,this.frictionEquationPool=J,this.result=U,this.frictionResult=nt;for(var ot=f,S=b,$=d,rt=x,ht=0,tt=P.length;ht!==tt;ht++){var Z=P[ht],it=I[ht],vt=null;Z.material&&it.material&&(vt=D.getContactMaterial(Z.material,it.material)||null);for(var wt=0;wt<Z.shapes.length;wt++){Z.quaternion.mult(Z.shapeOrientations[wt],ot),Z.quaternion.vmult(Z.shapeOffsets[wt],$),$.vadd(Z.position,$);for(var _=Z.shapes[wt],xt=0;xt<it.shapes.length;xt++){it.quaternion.mult(it.shapeOrientations[xt],S),it.quaternion.vmult(it.shapeOffsets[xt],rt),rt.vadd(it.position,rt);var gt=it.shapes[xt];if(!($.distanceTo(rt)>_.boundingSphereRadius+gt.boundingSphereRadius)){var Lt=null;_.material&&gt.material&&(Lt=D.getContactMaterial(_.material,gt.material)||null),this.currentContactMaterial=Lt||vt||D.defaultContactMaterial;var Bt=this[_.type|gt.type];Bt&&(_.type<gt.type?Bt.call(this,_,gt,$,rt,ot,S,Z,it,_,gt):Bt.call(this,gt,_,rt,$,S,ot,it,Z,_,gt))}}}}},a.prototype[e.types.BOX|e.types.BOX]=a.prototype.boxBox=function(P,I,D,U,yt,nt,J,ot){P.convexPolyhedronRepresentation.material=P.material,I.convexPolyhedronRepresentation.material=I.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,I.convexPolyhedronRepresentation,D,U,yt,nt,J,ot,P,I)},a.prototype[e.types.BOX|e.types.CONVEXPOLYHEDRON]=a.prototype.boxConvex=function(P,I,D,U,yt,nt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexConvex(P.convexPolyhedronRepresentation,I,D,U,yt,nt,J,ot,P,I)},a.prototype[e.types.BOX|e.types.PARTICLE]=a.prototype.boxParticle=function(P,I,D,U,yt,nt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexParticle(P.convexPolyhedronRepresentation,I,D,U,yt,nt,J,ot,P,I)},a.prototype[e.types.SPHERE]=a.prototype.sphereSphere=function(P,I,D,U,yt,nt,J,ot){var S=this.createContactEquation(J,ot,P,I);U.vsub(D,S.ni),S.ni.normalize(),S.ri.copy(S.ni),S.rj.copy(S.ni),S.ri.mult(P.radius,S.ri),S.rj.mult(-I.radius,S.rj),S.ri.vadd(D,S.ri),S.ri.vsub(J.position,S.ri),S.rj.vadd(U,S.rj),S.rj.vsub(ot.position,S.rj),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)};var G=new r,st=new r,T=new r;a.prototype[e.types.PLANE|e.types.TRIMESH]=a.prototype.planeTrimesh=function(P,I,D,U,yt,nt,J,ot){var S=new r,$=G;$.set(0,0,1),yt.vmult($,$);for(var rt=0;rt<I.vertices.length/3;rt++){I.getVertex(rt,S);var ht=new r;ht.copy(S),l.pointToWorldFrame(U,nt,ht,S);var tt=st;S.vsub(D,tt);var Z=$.dot(tt);if(Z<=0){var it=this.createContactEquation(J,ot,P,I);it.ni.copy($);var vt=T;$.scale(tt.dot($),vt),S.vsub(vt,vt),it.ri.copy(vt),it.ri.vsub(J.position,it.ri),it.rj.copy(S),it.rj.vsub(ot.position,it.rj),this.result.push(it),this.createFrictionEquationsFromContact(it,this.frictionResult)}}};var k=new r,M=new r;new r;var B=new r,N=new r,F=new r,j=new r,K=new r,pt=new r,z=new r,E=new r,Y=new r,q=new r,g=new r,R=new p,w=[];a.prototype[e.types.SPHERE|e.types.TRIMESH]=a.prototype.sphereTrimesh=function(P,I,D,U,yt,nt,J,ot){var S=F,$=j,rt=K,ht=pt,tt=z,Z=E,it=R,vt=N,wt=M,_=w;l.pointToLocalFrame(U,nt,D,tt);var xt=P.radius;it.lowerBound.set(tt.x-xt,tt.y-xt,tt.z-xt),it.upperBound.set(tt.x+xt,tt.y+xt,tt.z+xt),I.getTrianglesInAABB(it,_);for(var gt=B,Lt=P.radius*P.radius,Bt=0;Bt<_.length;Bt++)for(var Ct=0;Ct<3;Ct++)if(I.getVertex(I.indices[_[Bt]*3+Ct],gt),gt.vsub(tt,wt),wt.norm2()<=Lt){vt.copy(gt),l.pointToWorldFrame(U,nt,vt,gt),gt.vsub(D,wt);var dt=this.createContactEquation(J,ot,P,I);dt.ni.copy(wt),dt.ni.normalize(),dt.ri.copy(dt.ni),dt.ri.scale(P.radius,dt.ri),dt.ri.vadd(D,dt.ri),dt.ri.vsub(J.position,dt.ri),dt.rj.copy(gt),dt.rj.vsub(ot.position,dt.rj),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}for(var Bt=0;Bt<_.length;Bt++)for(var Ct=0;Ct<3;Ct++){I.getVertex(I.indices[_[Bt]*3+Ct],S),I.getVertex(I.indices[_[Bt]*3+(Ct+1)%3],$),$.vsub(S,rt),tt.vsub($,Z);var Jt=Z.dot(rt);tt.vsub(S,Z);var $t=Z.dot(rt);if($t>0&&Jt<0){tt.vsub(S,Z),ht.copy(rt),ht.normalize(),$t=Z.dot(ht),ht.scale($t,Z),Z.vadd(S,Z);var Xt=Z.distanceTo(tt);if(Xt<P.radius){var dt=this.createContactEquation(J,ot,P,I);Z.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(P.radius,dt.ri),l.pointToWorldFrame(U,nt,Z,Z),Z.vsub(ot.position,dt.rj),l.vectorToWorldFrame(nt,dt.ni,dt.ni),l.vectorToWorldFrame(nt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}}for(var se=Y,_t=q,Vt=g,le=k,Bt=0,Nt=_.length;Bt!==Nt;Bt++){I.getTriangleVertices(_[Bt],se,_t,Vt),I.getNormal(_[Bt],le),tt.vsub(se,Z);var Xt=Z.dot(le);if(le.scale(Xt,Z),tt.vsub(Z,Z),Xt=Z.distanceTo(tt),s.pointInTriangle(Z,se,_t,Vt)&&Xt<P.radius){var dt=this.createContactEquation(J,ot,P,I);Z.vsub(tt,dt.ni),dt.ni.normalize(),dt.ni.scale(P.radius,dt.ri),l.pointToWorldFrame(U,nt,Z,Z),Z.vsub(ot.position,dt.rj),l.vectorToWorldFrame(nt,dt.ni,dt.ni),l.vectorToWorldFrame(nt,dt.ri,dt.ri),this.result.push(dt),this.createFrictionEquationsFromContact(dt,this.frictionResult)}}_.length=0};var m=new r,y=new r;a.prototype[e.types.SPHERE|e.types.PLANE]=a.prototype.spherePlane=function(P,I,D,U,yt,nt,J,ot){var S=this.createContactEquation(J,ot,P,I);if(S.ni.set(0,0,1),nt.vmult(S.ni,S.ni),S.ni.negate(S.ni),S.ni.normalize(),S.ni.mult(P.radius,S.ri),D.vsub(U,m),S.ni.mult(S.ni.dot(m),y),m.vsub(y,S.rj),-m.dot(S.ni)<=P.radius){var $=S.ri,rt=S.rj;$.vadd(D,$),$.vsub(J.position,$),rt.vadd(U,rt),rt.vsub(ot.position,rt),this.result.push(S),this.createFrictionEquationsFromContact(S,this.frictionResult)}};var C=new r,H=new r,W=new r;function A(P,I,D){for(var U=null,yt=P.length,nt=0;nt!==yt;nt++){var J=P[nt],ot=C;P[(nt+1)%yt].vsub(J,ot);var S=H;ot.cross(I,S);var $=W;D.vsub(J,$);var rt=S.dot($);if(U===null||rt>0&&U===!0||rt<=0&&U===!1){U===null&&(U=rt>0);continue}else return!1}return!0}var L=new r,X=new r,ut=new r,lt=new r,at=[new r,new r,new r,new r,new r,new r],O=new r,Q=new r,bt=new r,ft=new r;a.prototype[e.types.SPHERE|e.types.BOX]=a.prototype.sphereBox=function(P,I,D,U,yt,nt,J,ot){var S=this.v3pool,$=at;D.vsub(U,L),I.getSideNormals($,nt);for(var rt=P.radius,ht=!1,tt=Q,Z=bt,it=ft,vt=null,wt=0,_=0,xt=0,gt=null,Lt=0,Bt=$.length;Lt!==Bt&&ht===!1;Lt++){var Ct=X;Ct.copy($[Lt]);var dt=Ct.norm();Ct.normalize();var Jt=L.dot(Ct);if(Jt<dt+rt&&Jt>0){var $t=ut,Xt=lt;$t.copy($[(Lt+1)%3]),Xt.copy($[(Lt+2)%3]);var se=$t.norm(),_t=Xt.norm();$t.normalize(),Xt.normalize();var Vt=L.dot($t),le=L.dot(Xt);if(Vt<se&&Vt>-se&&le<_t&&le>-_t){var kt=Math.abs(Jt-dt-rt);(gt===null||kt<gt)&&(gt=kt,_=Vt,xt=le,vt=dt,tt.copy(Ct),Z.copy($t),it.copy(Xt),wt++)}}}if(wt){ht=!0;var mt=this.createContactEquation(J,ot,P,I);tt.mult(-rt,mt.ri),mt.ni.copy(tt),mt.ni.negate(mt.ni),tt.mult(vt,tt),Z.mult(_,Z),tt.vadd(Z,tt),it.mult(xt,it),tt.vadd(it,mt.rj),mt.ri.vadd(D,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(U,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}for(var Nt=S.get(),he=O,Yt=0;Yt!==2&&!ht;Yt++)for(var Gt=0;Gt!==2&&!ht;Gt++)for(var Ht=0;Ht!==2&&!ht;Ht++)if(Nt.set(0,0,0),Yt?Nt.vadd($[0],Nt):Nt.vsub($[0],Nt),Gt?Nt.vadd($[1],Nt):Nt.vsub($[1],Nt),Ht?Nt.vadd($[2],Nt):Nt.vsub($[2],Nt),U.vadd(Nt,he),he.vsub(D,he),he.norm2()<rt*rt){ht=!0;var mt=this.createContactEquation(J,ot,P,I);mt.ri.copy(he),mt.ri.normalize(),mt.ni.copy(mt.ri),mt.ri.mult(rt,mt.ri),mt.rj.copy(Nt),mt.ri.vadd(D,mt.ri),mt.ri.vsub(J.position,mt.ri),mt.rj.vadd(U,mt.rj),mt.rj.vsub(ot.position,mt.rj),this.result.push(mt),this.createFrictionEquationsFromContact(mt,this.frictionResult)}S.release(Nt),Nt=null;for(var te=S.get(),ce=S.get(),mt=S.get(),Zt=S.get(),kt=S.get(),me=$.length,Yt=0;Yt!==me&&!ht;Yt++)for(var Gt=0;Gt!==me&&!ht;Gt++)if(Yt%3!==Gt%3){$[Gt].cross($[Yt],te),te.normalize(),$[Yt].vadd($[Gt],ce),mt.copy(D),mt.vsub(ce,mt),mt.vsub(U,mt);var we=mt.dot(te);te.mult(we,Zt);for(var Ht=0;Ht===Yt%3||Ht===Gt%3;)Ht++;kt.copy(D),kt.vsub(Zt,kt),kt.vsub(ce,kt),kt.vsub(U,kt);var Ve=Math.abs(we),Te=kt.norm();if(Ve<$[Ht].norm()&&Te<rt){ht=!0;var It=this.createContactEquation(J,ot,P,I);ce.vadd(Zt,It.rj),It.rj.copy(It.rj),kt.negate(It.ni),It.ni.normalize(),It.ri.copy(It.rj),It.ri.vadd(U,It.ri),It.ri.vsub(D,It.ri),It.ri.normalize(),It.ri.mult(rt,It.ri),It.ri.vadd(D,It.ri),It.ri.vsub(J.position,It.ri),It.rj.vadd(U,It.rj),It.rj.vsub(ot.position,It.rj),this.result.push(It),this.createFrictionEquationsFromContact(It,this.frictionResult)}}S.release(te,ce,mt,Zt,kt)};var Pt=new r,ct=new r,Mt=new r,zt=new r,Rt=new r,Tt=new r,Et=new r,Ft=new r,At=new r,qt=new r;a.prototype[e.types.SPHERE|e.types.CONVEXPOLYHEDRON]=a.prototype.sphereConvex=function(P,I,D,U,yt,nt,J,ot){var S=this.v3pool;D.vsub(U,Pt);for(var $=I.faceNormals,rt=I.faces,ht=I.vertices,tt=P.radius,Z=0;Z!==ht.length;Z++){var it=ht[Z],vt=Rt;nt.vmult(it,vt),U.vadd(vt,vt);var wt=zt;if(vt.vsub(D,wt),wt.norm2()<tt*tt){xt=!0;var _=this.createContactEquation(J,ot,P,I);_.ri.copy(wt),_.ri.normalize(),_.ni.copy(_.ri),_.ri.mult(tt,_.ri),vt.vsub(U,_.rj),_.ri.vadd(D,_.ri),_.ri.vsub(J.position,_.ri),_.rj.vadd(U,_.rj),_.rj.vsub(ot.position,_.rj),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult);return}}for(var xt=!1,Z=0,gt=rt.length;Z!==gt&&xt===!1;Z++){var Lt=$[Z],Bt=rt[Z],Ct=Tt;nt.vmult(Lt,Ct);var dt=Et;nt.vmult(ht[Bt[0]],dt),dt.vadd(U,dt);var Jt=Ft;Ct.mult(-tt,Jt),D.vadd(Jt,Jt);var $t=At;Jt.vsub(dt,$t);var Xt=$t.dot(Ct),se=qt;if(D.vsub(dt,se),Xt<0&&se.dot(Ct)>0){for(var _t=[],Vt=0,le=Bt.length;Vt!==le;Vt++){var Nt=S.get();nt.vmult(ht[Bt[Vt]],Nt),U.vadd(Nt,Nt),_t.push(Nt)}if(A(_t,Ct,D)){xt=!0;var _=this.createContactEquation(J,ot,P,I);Ct.mult(-tt,_.ri),Ct.negate(_.ni);var he=S.get();Ct.mult(-Xt,he);var Yt=S.get();Ct.mult(-tt,Yt),D.vsub(U,_.rj),_.rj.vadd(Yt,_.rj),_.rj.vadd(he,_.rj),_.rj.vadd(U,_.rj),_.rj.vsub(ot.position,_.rj),_.ri.vadd(D,_.ri),_.ri.vsub(J.position,_.ri),S.release(he),S.release(Yt),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult);for(var Vt=0,Gt=_t.length;Vt!==Gt;Vt++)S.release(_t[Vt]);return}else for(var Vt=0;Vt!==Bt.length;Vt++){var Ht=S.get(),te=S.get();nt.vmult(ht[Bt[(Vt+1)%Bt.length]],Ht),nt.vmult(ht[Bt[(Vt+2)%Bt.length]],te),U.vadd(Ht,Ht),U.vadd(te,te);var ce=ct;te.vsub(Ht,ce);var mt=Mt;ce.unit(mt);var Zt=S.get(),kt=S.get();D.vsub(Ht,kt);var me=kt.dot(mt);mt.mult(me,Zt),Zt.vadd(Ht,Zt);var we=S.get();if(Zt.vsub(D,we),me>0&&me*me<ce.norm2()&&we.norm2()<tt*tt){var _=this.createContactEquation(J,ot,P,I);Zt.vsub(U,_.rj),Zt.vsub(D,_.ni),_.ni.normalize(),_.ni.mult(tt,_.ri),_.rj.vadd(U,_.rj),_.rj.vsub(ot.position,_.rj),_.ri.vadd(D,_.ri),_.ri.vsub(J.position,_.ri),this.result.push(_),this.createFrictionEquationsFromContact(_,this.frictionResult);for(var Vt=0,Gt=_t.length;Vt!==Gt;Vt++)S.release(_t[Vt]);S.release(Ht),S.release(te),S.release(Zt),S.release(we),S.release(kt);return}S.release(Ht),S.release(te),S.release(Zt),S.release(we),S.release(kt)}for(var Vt=0,Gt=_t.length;Vt!==Gt;Vt++)S.release(_t[Vt])}}},new r,new r,a.prototype[e.types.PLANE|e.types.BOX]=a.prototype.planeBox=function(P,I,D,U,yt,nt,J,ot){I.convexPolyhedronRepresentation.material=I.material,I.convexPolyhedronRepresentation.collisionResponse=I.collisionResponse,this.planeConvex(P,I.convexPolyhedronRepresentation,D,U,yt,nt,J,ot)};var Ut=new r,ne=new r,ue=new r,ae=new r;a.prototype[e.types.PLANE|e.types.CONVEXPOLYHEDRON]=a.prototype.planeConvex=function(P,I,D,U,yt,nt,J,ot){var S=Ut,$=ne;$.set(0,0,1),yt.vmult($,$);for(var rt=0,ht=ue,tt=0;tt!==I.vertices.length;tt++){S.copy(I.vertices[tt]),nt.vmult(S,S),U.vadd(S,S),S.vsub(D,ht);var Z=$.dot(ht);if(Z<=0){var it=this.createContactEquation(J,ot,P,I),vt=ae;$.mult($.dot(ht),vt),S.vsub(vt,vt),vt.vsub(D,it.ri),it.ni.copy($),S.vsub(U,it.rj),it.ri.vadd(D,it.ri),it.ri.vsub(J.position,it.ri),it.rj.vadd(U,it.rj),it.rj.vsub(ot.position,it.rj),this.result.push(it),rt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(it,this.frictionResult)}}this.enableFrictionReduction&&rt&&this.createFrictionFromAverage(rt)};var Kt=new r,jt=new r;a.prototype[e.types.CONVEXPOLYHEDRON]=a.prototype.convexConvex=function(P,I,D,U,yt,nt,J,ot,S,$,rt,ht){var tt=Kt;if(!(D.distanceTo(U)>P.boundingSphereRadius+I.boundingSphereRadius)&&P.findSeparatingAxis(I,D,yt,U,nt,tt,rt,ht)){var Z=[],it=jt;P.clipAgainstHull(D,yt,I,U,nt,tt,-100,100,Z);for(var vt=0,wt=0;wt!==Z.length;wt++){var _=this.createContactEquation(J,ot,P,I,S,$),xt=_.ri,gt=_.rj;tt.negate(_.ni),Z[wt].normal.negate(it),it.mult(Z[wt].depth,it),Z[wt].point.vadd(it,xt),gt.copy(Z[wt].point),xt.vsub(D,xt),gt.vsub(U,gt),xt.vadd(D,xt),xt.vsub(J.position,xt),gt.vadd(U,gt),gt.vsub(ot.position,gt),this.result.push(_),vt++,this.enableFrictionReduction||this.createFrictionEquationsFromContact(_,this.frictionResult)}this.enableFrictionReduction&&vt&&this.createFrictionFromAverage(vt)}};var ve=new r,pe=new r,oe=new r;a.prototype[e.types.PLANE|e.types.PARTICLE]=a.prototype.planeParticle=function(P,I,D,U,yt,nt,J,ot){var S=ve;S.set(0,0,1),J.quaternion.vmult(S,S);var $=pe;U.vsub(J.position,$);var rt=S.dot($);if(rt<=0){var ht=this.createContactEquation(ot,J,I,P);ht.ni.copy(S),ht.ni.negate(ht.ni),ht.ri.set(0,0,0);var tt=oe;S.mult(S.dot(U),tt),U.vsub(tt,tt),ht.rj.copy(tt),this.result.push(ht),this.createFrictionEquationsFromContact(ht,this.frictionResult)}};var ee=new r;a.prototype[e.types.PARTICLE|e.types.SPHERE]=a.prototype.sphereParticle=function(P,I,D,U,yt,nt,J,ot){var S=ee;S.set(0,0,1),U.vsub(D,S);var $=S.norm2();if($<=P.radius*P.radius){var rt=this.createContactEquation(ot,J,I,P);S.normalize(),rt.rj.copy(S),rt.rj.mult(P.radius,rt.rj),rt.ni.copy(S),rt.ni.negate(rt.ni),rt.ri.set(0,0,0),this.result.push(rt),this.createFrictionEquationsFromContact(rt,this.frictionResult)}};var Qt=new i,re=new r;new r;var ie=new r,Dt=new r,de=new r;a.prototype[e.types.PARTICLE|e.types.CONVEXPOLYHEDRON]=a.prototype.convexParticle=function(P,I,D,U,yt,nt,J,ot){var S=-1,$=ie,rt=de,ht=null,tt=re;if(tt.copy(U),tt.vsub(D,tt),yt.conjugate(Qt),Qt.vmult(tt,tt),P.pointIsInside(tt)){P.worldVerticesNeedsUpdate&&P.computeWorldVertices(D,yt),P.worldFaceNormalsNeedsUpdate&&P.computeWorldFaceNormals(yt);for(var Z=0,it=P.faces.length;Z!==it;Z++){var vt=[P.worldVertices[P.faces[Z][0]]],wt=P.worldFaceNormals[Z];U.vsub(vt[0],Dt);var _=-wt.dot(Dt);(ht===null||Math.abs(_)<Math.abs(ht))&&(ht=_,S=Z,$.copy(wt))}if(S!==-1){var xt=this.createContactEquation(ot,J,I,P);$.mult(ht,rt),rt.vadd(U,rt),rt.vsub(D,rt),xt.rj.copy(rt),$.negate(xt.ni),xt.ri.set(0,0,0);var gt=xt.ri,Lt=xt.rj;gt.vadd(U,gt),gt.vsub(ot.position,gt),Lt.vadd(D,Lt),Lt.vsub(J.position,Lt),this.result.push(xt),this.createFrictionEquationsFromContact(xt,this.frictionResult)}else console.warn("Point found inside convex, but did not find penetrating face!")}},a.prototype[e.types.BOX|e.types.HEIGHTFIELD]=a.prototype.boxHeightfield=function(P,I,D,U,yt,nt,J,ot){P.convexPolyhedronRepresentation.material=P.material,P.convexPolyhedronRepresentation.collisionResponse=P.collisionResponse,this.convexHeightfield(P.convexPolyhedronRepresentation,I,D,U,yt,nt,J,ot)};var fe=new r,ye=new r,xe=[0];a.prototype[e.types.CONVEXPOLYHEDRON|e.types.HEIGHTFIELD]=a.prototype.convexHeightfield=function(P,I,D,U,yt,nt,J,ot){var S=I.data,$=I.elementSize,rt=P.boundingSphereRadius,ht=ye,tt=xe,Z=fe;l.pointToLocalFrame(U,nt,D,Z);var it=Math.floor((Z.x-rt)/$)-1,vt=Math.ceil((Z.x+rt)/$)+1,wt=Math.floor((Z.y-rt)/$)-1,_=Math.ceil((Z.y+rt)/$)+1;if(!(vt<0||_<0||it>S.length||wt>S[0].length)){it<0&&(it=0),vt<0&&(vt=0),wt<0&&(wt=0),_<0&&(_=0),it>=S.length&&(it=S.length-1),vt>=S.length&&(vt=S.length-1),_>=S[0].length&&(_=S[0].length-1),wt>=S[0].length&&(wt=S[0].length-1);var xt=[];I.getRectMinMax(it,wt,vt,_,xt);var gt=xt[0],Lt=xt[1];if(!(Z.z-rt>Lt||Z.z+rt<gt))for(var Bt=it;Bt<vt;Bt++)for(var Ct=wt;Ct<_;Ct++)I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(U,nt,I.pillarOffset,ht),D.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,I.pillarConvex,D,ht,yt,nt,J,ot,null,null,tt,null),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(U,nt,I.pillarOffset,ht),D.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.convexConvex(P,I.pillarConvex,D,ht,yt,nt,J,ot,null,null,tt,null)}};var ge=new r,Ot=new r;a.prototype[e.types.SPHERE|e.types.HEIGHTFIELD]=a.prototype.sphereHeightfield=function(P,I,D,U,yt,nt,J,ot){var S=I.data,$=P.radius,rt=I.elementSize,ht=Ot,tt=ge;l.pointToLocalFrame(U,nt,D,tt);var Z=Math.floor((tt.x-$)/rt)-1,it=Math.ceil((tt.x+$)/rt)+1,vt=Math.floor((tt.y-$)/rt)-1,wt=Math.ceil((tt.y+$)/rt)+1;if(!(it<0||wt<0||Z>S.length||wt>S[0].length)){Z<0&&(Z=0),it<0&&(it=0),vt<0&&(vt=0),wt<0&&(wt=0),Z>=S.length&&(Z=S.length-1),it>=S.length&&(it=S.length-1),wt>=S[0].length&&(wt=S[0].length-1),vt>=S[0].length&&(vt=S[0].length-1);var _=[];I.getRectMinMax(Z,vt,it,wt,_);var xt=_[0],gt=_[1];if(!(tt.z-$>gt||tt.z+$<xt))for(var Lt=this.result,Bt=Z;Bt<it;Bt++)for(var Ct=vt;Ct<wt;Ct++){var dt=Lt.length;I.getConvexTrianglePillar(Bt,Ct,!1),l.pointToWorldFrame(U,nt,I.pillarOffset,ht),D.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,I.pillarConvex,D,ht,yt,nt,J,ot),I.getConvexTrianglePillar(Bt,Ct,!0),l.pointToWorldFrame(U,nt,I.pillarOffset,ht),D.distanceTo(ht)<I.pillarConvex.boundingSphereRadius+P.boundingSphereRadius&&this.sphereConvex(P,I.pillarConvex,D,ht,yt,nt,J,ot);var Jt=Lt.length-dt;if(Jt>2)return}}}},{"../collision/AABB":3,"../collision/Ray":9,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../math/Quaternion":28,"../math/Transform":29,"../math/Vec3":30,"../shapes/ConvexPolyhedron":38,"../shapes/Shape":43,"../solver/Solver":47,"../utils/Vec3Pool":54}],56:[function(v,V,et){V.exports=f;var p=v("../shapes/Shape"),e=v("../math/Vec3"),s=v("../math/Quaternion"),r=v("../solver/GSSolver");v("../utils/Vec3Pool"),v("../equations/ContactEquation"),v("../equations/FrictionEquation");var l=v("./Narrowphase"),i=v("../utils/EventTarget"),t=v("../collision/ArrayCollisionMatrix"),o=v("../material/Material"),n=v("../material/ContactMaterial"),a=v("../objects/Body"),c=v("../utils/TupleDictionary"),h=v("../collision/RaycastResult"),u=v("../collision/AABB"),d=v("../collision/Ray"),x=v("../collision/NaiveBroadphase");function f(){i.apply(this),this.dt=-1,this.allowSleep=!1,this.contacts=[],this.frictionEquations=[],this.quatNormalizeSkip=0,this.quatNormalizeFast=!1,this.time=0,this.stepnumber=0,this.default_dt=1/60,this.nextId=0,this.gravity=new e,this.broadphase=new x,this.bodies=[],this.solver=new r,this.constraints=[],this.narrowphase=new l(this),this.collisionMatrix=new t,this.collisionMatrixPrevious=new t,this.materials=[],this.contactmaterials=[],this.contactMaterialTable=new c,this.defaultMaterial=new o("default"),this.defaultContactMaterial=new n(this.defaultMaterial,this.defaultMaterial,{friction:.3,restitution:0}),this.doProfiling=!1,this.profile={solve:0,makeContactConstraints:0,broadphase:0,integrate:0,narrowphase:0},this.subsystems=[],this.addBodyEvent={type:"addBody",body:null},this.removeBodyEvent={type:"removeBody",body:null}}f.prototype=new i,new u;var b=new d;if(f.prototype.getContactMaterial=function(E,Y){return this.contactMaterialTable.get(E.id,Y.id)},f.prototype.numObjects=function(){return this.bodies.length},f.prototype.collisionMatrixTick=function(){var E=this.collisionMatrixPrevious;this.collisionMatrixPrevious=this.collisionMatrix,this.collisionMatrix=E,this.collisionMatrix.reset()},f.prototype.add=f.prototype.addBody=function(E){this.bodies.indexOf(E)===-1&&(E.index=this.bodies.length,this.bodies.push(E),E.world=this,E.initPosition.copy(E.position),E.initVelocity.copy(E.velocity),E.timeLastSleepy=this.time,E instanceof a&&(E.initAngularVelocity.copy(E.angularVelocity),E.initQuaternion.copy(E.quaternion)),this.collisionMatrix.setNumObjects(this.bodies.length),this.addBodyEvent.body=E,this.dispatchEvent(this.addBodyEvent))},f.prototype.addConstraint=function(E){this.constraints.push(E)},f.prototype.removeConstraint=function(E){var Y=this.constraints.indexOf(E);Y!==-1&&this.constraints.splice(Y,1)},f.prototype.rayTest=function(E,Y,q){q instanceof h?this.raycastClosest(E,Y,{skipBackfaces:!0},q):this.raycastAll(E,Y,{skipBackfaces:!0},q)},f.prototype.raycastAll=function(E,Y,q,g){return q.mode=d.ALL,q.from=E,q.to=Y,q.callback=g,b.intersectWorld(this,q)},f.prototype.raycastAny=function(E,Y,q,g){return q.mode=d.ANY,q.from=E,q.to=Y,q.result=g,b.intersectWorld(this,q)},f.prototype.raycastClosest=function(E,Y,q,g){return q.mode=d.CLOSEST,q.from=E,q.to=Y,q.result=g,b.intersectWorld(this,q)},f.prototype.remove=function(E){E.world=null;var Y=this.bodies.length-1,q=this.bodies,g=q.indexOf(E);if(g!==-1){q.splice(g,1);for(var R=0;R!==q.length;R++)q[R].index=R;this.collisionMatrix.setNumObjects(Y),this.removeBodyEvent.body=E,this.dispatchEvent(this.removeBodyEvent)}},f.prototype.removeBody=f.prototype.remove,f.prototype.addMaterial=function(E){this.materials.push(E)},f.prototype.addContactMaterial=function(E){this.contactmaterials.push(E),this.contactMaterialTable.set(E.materials[0].id,E.materials[1].id,E)},typeof performance>"u"&&(performance={}),!performance.now){var G=Date.now();performance.timing&&performance.timing.navigationStart&&(G=performance.timing.navigationStart),performance.now=function(){return Date.now()-G}}var st=new e;f.prototype.step=function(E,Y,q){if(q=q||10,Y=Y||0,Y===0)this.internalStep(E),this.time+=E;else{var g=Math.floor((this.time+Y)/E)-Math.floor(this.time/E);g=Math.min(g,q);for(var R=performance.now(),w=0;w!==g&&(this.internalStep(E),!(performance.now()-R>E*1e3));w++);this.time+=Y;for(var m=this.time%E,y=m/E,C=st,H=this.bodies,W=0;W!==H.length;W++){var A=H[W];A.type!==a.STATIC&&A.sleepState!==a.SLEEPING?(A.position.vsub(A.previousPosition,C),C.scale(y,C),A.position.vadd(C,A.interpolatedPosition)):(A.interpolatedPosition.copy(A.position),A.interpolatedQuaternion.copy(A.quaternion))}}};var T={type:"postStep"},k={type:"preStep"},M={type:"collide",body:null,contact:null},B=[],N=[],F=[],j=[];new e,new e,new e,new e,new e,new e,new e,new e,new e,new s;var K=new s,pt=new s,z=new e;f.prototype.internalStep=function(E){this.dt=E;var Y=this.contacts,q=F,g=j,R=this.numObjects(),w=this.bodies,m=this.solver,y=this.gravity,C=this.doProfiling,H=this.profile,W=a.DYNAMIC,A,L=this.constraints,X=N;y.norm();var ut=y.x,lt=y.y,at=y.z,O=0;for(C&&(A=performance.now()),O=0;O!==R;O++){var Q=w[O];if(Q.type&W){var bt=Q.force,ft=Q.mass;bt.x+=ft*ut,bt.y+=ft*lt,bt.z+=ft*at}}for(var O=0,Pt=this.subsystems.length;O!==Pt;O++)this.subsystems[O].update();C&&(A=performance.now()),q.length=0,g.length=0,this.broadphase.collisionPairs(this,q,g),C&&(H.broadphase=performance.now()-A);var Kt=L.length;for(O=0;O!==Kt;O++){var ct=L[O];if(!ct.collideConnected)for(var Mt=q.length-1;Mt>=0;Mt-=1)(ct.bodyA===q[Mt]&&ct.bodyB===g[Mt]||ct.bodyB===q[Mt]&&ct.bodyA===g[Mt])&&(q.splice(Mt,1),g.splice(Mt,1))}this.collisionMatrixTick(),C&&(A=performance.now());var zt=B,Rt=Y.length;for(O=0;O!==Rt;O++)zt.push(Y[O]);Y.length=0;var Tt=this.frictionEquations.length;for(O=0;O!==Tt;O++)X.push(this.frictionEquations[O]);this.frictionEquations.length=0,this.narrowphase.getContacts(q,g,this,Y,zt,this.frictionEquations,X),C&&(H.narrowphase=performance.now()-A),C&&(A=performance.now());for(var O=0;O<this.frictionEquations.length;O++)m.addEquation(this.frictionEquations[O]);for(var Et=Y.length,Ft=0;Ft!==Et;Ft++){var ct=Y[Ft],Q=ct.bi,At=ct.bj;ct.si,ct.sj;var qt;if(Q.material&&At.material?qt=this.getContactMaterial(Q.material,At.material)||this.defaultContactMaterial:qt=this.defaultContactMaterial,qt.friction,Q.material&&At.material&&(Q.material.friction>=0&&At.material.friction>=0&&Q.material.friction*At.material.friction,Q.material.restitution>=0&&At.material.restitution>=0&&(ct.restitution=Q.material.restitution*At.material.restitution)),m.addEquation(ct),Q.allowSleep&&Q.type===a.DYNAMIC&&Q.sleepState===a.SLEEPING&&At.sleepState===a.AWAKE&&At.type!==a.STATIC){var Ut=At.velocity.norm2()+At.angularVelocity.norm2(),ne=Math.pow(At.sleepSpeedLimit,2);Ut>=ne*2&&(Q._wakeUpAfterNarrowphase=!0)}if(At.allowSleep&&At.type===a.DYNAMIC&&At.sleepState===a.SLEEPING&&Q.sleepState===a.AWAKE&&Q.type!==a.STATIC){var ue=Q.velocity.norm2()+Q.angularVelocity.norm2(),ae=Math.pow(Q.sleepSpeedLimit,2);ue>=ae*2&&(At._wakeUpAfterNarrowphase=!0)}this.collisionMatrix.set(Q,At,!0),this.collisionMatrixPrevious.get(Q,At)||(M.body=At,M.contact=ct,Q.dispatchEvent(M),M.body=Q,At.dispatchEvent(M))}for(C&&(H.makeContactConstraints=performance.now()-A,A=performance.now()),O=0;O!==R;O++){var Q=w[O];Q._wakeUpAfterNarrowphase&&(Q.wakeUp(),Q._wakeUpAfterNarrowphase=!1)}var Kt=L.length;for(O=0;O!==Kt;O++){var ct=L[O];ct.update();for(var Mt=0,jt=ct.equations.length;Mt!==jt;Mt++){var ve=ct.equations[Mt];m.addEquation(ve)}}m.solve(E,this),C&&(H.solve=performance.now()-A),m.removeAllEquations();var pe=Math.pow;for(O=0;O!==R;O++){var Q=w[O];if(Q.type&W){var oe=pe(1-Q.linearDamping,E),ee=Q.velocity;ee.mult(oe,ee);var Qt=Q.angularVelocity;if(Qt){var re=pe(1-Q.angularDamping,E);Qt.mult(re,Qt)}}}for(this.dispatchEvent(k),O=0;O!==R;O++){var Q=w[O];Q.preStep&&Q.preStep.call(Q)}C&&(A=performance.now());var ie=K,Dt=pt,de=this.stepnumber,fe=a.DYNAMIC|a.KINEMATIC,ye=de%(this.quatNormalizeSkip+1)===0,xe=this.quatNormalizeFast,ge=E*.5;for(p.types.PLANE,p.types.CONVEXPOLYHEDRON,O=0;O!==R;O++){var Ot=w[O],P=Ot.force,I=Ot.torque;if(Ot.type&fe&&Ot.sleepState!==a.SLEEPING){var D=Ot.velocity,U=Ot.angularVelocity,yt=Ot.position,nt=Ot.quaternion,J=Ot.invMass,ot=Ot.invInertiaWorld;D.x+=P.x*J*E,D.y+=P.y*J*E,D.z+=P.z*J*E,Ot.angularVelocity&&(ot.vmult(I,z),z.mult(E,z),z.vadd(U,U)),yt.x+=D.x*E,yt.y+=D.y*E,yt.z+=D.z*E,Ot.angularVelocity&&(ie.set(U.x,U.y,U.z,0),ie.mult(nt,Dt),nt.x+=ge*Dt.x,nt.y+=ge*Dt.y,nt.z+=ge*Dt.z,nt.w+=ge*Dt.w,ye&&(xe?nt.normalizeFast():nt.normalize())),Ot.aabb&&(Ot.aabbNeedsUpdate=!0),Ot.updateInertiaWorld&&Ot.updateInertiaWorld()}}for(this.clearForces(),this.broadphase.dirty=!0,C&&(H.integrate=performance.now()-A),this.time+=E,this.stepnumber+=1,this.dispatchEvent(T),O=0;O!==R;O++){var Q=w[O],S=Q.postStep;S&&S.call(Q)}if(this.allowSleep)for(O=0;O!==R;O++)w[O].sleepTick(this.time)},f.prototype.clearForces=function(){for(var E=this.bodies,Y=E.length,q=0;q!==Y;q++){var g=E[q];g.force,g.torque,g.force.set(0,0,0),g.torque.set(0,0,0)}}},{"../collision/AABB":3,"../collision/ArrayCollisionMatrix":4,"../collision/NaiveBroadphase":7,"../collision/Ray":9,"../collision/RaycastResult":10,"../equations/ContactEquation":19,"../equations/FrictionEquation":21,"../material/ContactMaterial":24,"../material/Material":25,"../math/Quaternion":28,"../math/Vec3":30,"../objects/Body":31,"../shapes/Shape":43,"../solver/GSSolver":46,"../utils/EventTarget":49,"../utils/TupleDictionary":52,"../utils/Vec3Pool":54,"./Narrowphase":55}]},{},[2])(2)})})(Qe);class Ze{constructor(St){Be(this,"scene");Be(this,"playerModel");Be(this,"moveDirection");Be(this,"velocity",2);this.scene=St,this.playerModel=De.prototype,this.moveDirection=new Ue}async loadPlayerModel(){this.playerModel=await this.scene.loadModel("pacman.obj","pacman.png")}getPlayerModel(){return this.playerModel}update(St,v){this.handleKeyPress(v),this.movePlayer(St)}movePlayer(St){this.moveDirection.y=0,this.moveDirection.normalize();const v=this.moveDirection.x*this.velocity*St,V=this.moveDirection.z*this.velocity*St;this.playerModel.position.x+=v,this.playerModel.position.z+=V}handleKeyPress(St){St.A?this.moveDirection.x=-1:St.D?this.moveDirection.x=1:this.moveDirection.x=0,St.W?this.moveDirection.z=-1:St.S?this.moveDirection.z=1:this.moveDirection.z=0}}function Ke(Wt){let St,v,V,et;return{c(){St=Ae("div"),v=Ae("div"),V=qe(),et=Ae("canvas"),this.h()},l(p){St=Ce(p,"DIV",{});var e=Se(St);v=Ce(e,"DIV",{id:!0,class:!0}),Se(v).forEach(be),V=Oe(e),et=Ce(e,"CANVAS",{id:!0}),Se(et).forEach(be),e.forEach(be),this.h()},h(){Me(v,"id","canvas-placeholder"),Me(v,"class","svelte-5r6593"),Me(et,"id","minigame-canvas")},m(p,e){ke(p,St,e),Re(St,v),Re(St,V),Re(St,et),Wt[1](et)},p:ze,i:ze,o:ze,d(p){p&&be(St),Wt[1](null)}}}function je(){var Wt;return(Wt=document.getElementById("canvas-placeholder"))==null?void 0:Wt.offsetWidth}function Je(){var Wt;return(Wt=document.getElementById("canvas-placeholder"))==null?void 0:Wt.offsetHeight}function $e(Wt,St,v){let V,et,p,e;const s=new Ye,r={W:!1,A:!1,S:!1,D:!1};He(async()=>{await o(),await t(),await i(),await l(),n()});async function l(){document.addEventListener("keydown",a),document.addEventListener("keyup",c)}async function i(){p=await et.loadModel("pacman_map.obj","pacman_map.png"),p.scale.set(3,3,3);let d=p.children[0].geometry;console.log(d),e=new Ze(et),await e.loadPlayerModel(),e.getPlayerModel().scale.set(.05,.05,.05)}async function t(){et.camera.translateY(21),et.camera.translateX(-.15),et.camera.translateZ(-5),et.camera.rotateX(Xe.degToRad(-90))}async function o(){et=new _e(15),et.createScene(V),et.resize(je(),Je())}function n(){let u=s.getDelta();e.update(u,r),et.renderer.render(et.scene,et.camera),requestAnimationFrame(n)}function a(u){r[u.key.toUpperCase()]=!0}function c(u){r[u.key.toUpperCase()]=!1}function h(u){Ge[u?"unshift":"push"](()=>{V=u,v(0,V)})}return[V,h]}class oi extends Ie{constructor(St){super(),We(this,St,$e,Ke,Le,{})}}export{oi as default};
